<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --mermaid-theme: default; --mermaid-sequence-numbers: off; --mermaid-flowchart-curve: linear; --mermaid--gantt-left-padding: 75; --sequence-theme: simple; }


:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; bottom: 0px; top: 0px; left: 0px; right: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.md-inline-math .MathJax_SVG .noError { display: none !important; }
.html-for-mac .inline-math-svg .MathJax_SVG { vertical-align: 0.2px; }
.md-fences-math .MathJax_SVG_Display, .md-math-block .MathJax_SVG_Display { text-align: center; margin: 0px; position: relative; text-indent: 0px; max-width: none; max-height: none; min-height: 0px; min-width: 100%; width: auto; overflow-y: visible; display: block !important; }
.MathJax_SVG_Display, .md-inline-math .MathJax_SVG_Display { width: auto; margin: inherit; display: inline-block !important; }
.MathJax_SVG .MJX-monospace { font-family: var(--monospace); }
.MathJax_SVG .MJX-sans-serif { font-family: sans-serif; }
.MathJax_SVG { display: inline; font-style: normal; font-weight: 400; line-height: normal; text-indent: 0px; text-align: left; text-transform: none; letter-spacing: normal; word-spacing: normal; overflow-wrap: normal; white-space: nowrap; float: none; direction: ltr; max-width: none; max-height: none; min-width: 0px; min-height: 0px; border: 0px; padding: 0px; margin: 0px; zoom: 90%; }
#math-inline-preview-content { zoom: 1.1; }
.MathJax_SVG * { transition: none 0s ease 0s; }
.MathJax_SVG_Display svg { vertical-align: middle !important; margin-bottom: 0px !important; margin-top: 0px !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-require-zoom-fix foreignobject { font-size: var(--mermaid-font-zoom); }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-math .MathJax_SVG_Display { margin-top: 8px; cursor: default; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 30px; z-index: 3; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; left: 0px; right: 0px; top: 0px; bottom: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}

/** initialize css counter */
#write {
    counter-reset: h1
}

h1 {
    counter-reset: h2
}

h2 {
    counter-reset: h3
}

h3 {
    counter-reset: h4
}

h4 {
    counter-reset: h5
}

h5 {
    counter-reset: h6
}

/** put counter result into headings */
#write h1:before {
    counter-increment: h1;
    content: counter(h1) ". "
}

#write h2:before {
    counter-increment: h2;
    content: counter(h1) "." counter(h2) ". "
}

#write h3:before,
h3.md-focus.md-heading:before /** override the default style for focused headings */ {
    counter-increment: h3;
    content: counter(h1) "." counter(h2) "." counter(h3) ". "
}

#write h4:before,
h4.md-focus.md-heading:before {
    counter-increment: h4;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) ". "
}

#write h5:before,
h5.md-focus.md-heading:before {
    counter-increment: h5;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) ". "
}

#write h6:before,
h6.md-focus.md-heading:before {
    counter-increment: h6;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) "." counter(h6) ". "
}

/** override the default style for focused headings */
#write>h3.md-focus:before,
#write>h4.md-focus:before,
#write>h5.md-focus:before,
#write>h6.md-focus:before,
h3.md-focus:before,
h4.md-focus:before,
h5.md-focus:before,
h6.md-focus:before {
    color: inherit;
    border: inherit;
    border-radius: inherit;
    position: inherit;
    left:initial;
    float: none;
    top:initial;
    font-size: inherit;
    padding-left: inherit;
    padding-right: inherit;
    vertical-align: inherit;
    font-weight: inherit;
    line-height: inherit;
}
/**************************************
 * Header Counters in TOC
 **************************************/
 
/* No link underlines in TOC */
.md-toc-inner {
    text-decoration: none;
}
 
.md-toc-content {
    counter-reset: h1toc
}
 
.md-toc-h1 {
    margin-left: 0;
    font-size: 1.5rem;
    counter-reset: h2toc
}
 
.md-toc-h2 {
    font-size: 1.1rem;
    margin-left: 2rem;
    counter-reset: h3toc
}
 
.md-toc-h3 {
    margin-left: 3rem;
    font-size: .9rem;
    counter-reset: h4toc
}
 
.md-toc-h4 {
    margin-left: 4rem;
    font-size: .85rem;
    counter-reset: h5toc
}
 
.md-toc-h5 {
    margin-left: 5rem;
    font-size: .8rem;
    counter-reset: h6toc
}
 
.md-toc-h6 {
    margin-left: 6rem;
    font-size: .75rem;
}
 
.md-toc-h1:before {
    color: black;
    counter-increment: h1toc;
    content: counter(h1toc) ". "
}
 
.md-toc-h1 .md-toc-inner {
    margin-left: 0;
}
 
.md-toc-h2:before {
    color: black;
    counter-increment: h2toc;
    content: counter(h1toc) ". " counter(h2toc) ". "
}
 
.md-toc-h2 .md-toc-inner {
    margin-left: 0;
}
 
.md-toc-h3:before {
    color: black;
    counter-increment: h3toc;
    content: counter(h1toc) ". " counter(h2toc) ". " counter(h3toc) ". "
}
 
.md-toc-h3 .md-toc-inner {
    margin-left: 0;
}
 
.md-toc-h4:before {
    color: black;
    counter-increment: h4toc;
    content: counter(h1toc) ". " counter(h2toc) ". " counter(h3toc) ". " counter(h4toc) ". "
}
 
.md-toc-h4 .md-toc-inner {
    margin-left: 0;
}
 
.md-toc-h5:before {
    color: black;
    counter-increment: h5toc;
    content: counter(h1toc) ". " counter(h2toc) ". " counter(h3toc) ". " counter(h4toc) ". " counter(h5toc) ". "
}
 
.md-toc-h5 .md-toc-inner {
    margin-left: 0;
}
 
.md-toc-h6:before {
    color: black;
    counter-increment: h6toc;
    content: counter(h1toc) ". " counter(h2toc) ". " counter(h3toc) ". " counter(h4toc) ". " counter(h5toc) ". " counter(h6toc) ". "
}
 
.md-toc-h6 .md-toc-inner {
    margin-left: 0;
}
 
/**************************************
 * Header Counters in Content
 **************************************/
 
/** initialize css counter */
#write {
    counter-reset: h1
}
 
h1 {
    counter-reset: h2
}
 
h2 {
    counter-reset: h3
}
 
h3 {
    counter-reset: h4
}
 
h4 {
    counter-reset: h5
}
 
h5 {
    counter-reset: h6
}
 
/** put counter result into headings */
#write h1:before {
    counter-increment: h1;
    content: counter(h1) ". "
}
 
#write h2:before {
    counter-increment: h2;
    content: counter(h1) "." counter(h2) ". "
}
 
#write h3:before, h3.md-focus.md-heading:before { /*override the default style for focused headings */
    counter-increment: h3;
    content: counter(h1) "." counter(h2) "." counter(h3) ". "
}
 
#write h4:before, h4.md-focus.md-heading:before {
    counter-increment: h4;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) ". "
}
 
#write h5:before, h5.md-focus.md-heading:before {
    counter-increment: h5;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) ". "
}
 
#write h6:before, h6.md-focus.md-heading:before {
    counter-increment: h6;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) "." counter(h6) ". "
}
 
/** override the default style for focused headings */
#write>h3.md-focus:before, #write>h4.md-focus:before, #write>h5.md-focus:before, #write>h6.md-focus:before, h3.md-focus:before, h4.md-focus:before, h5.md-focus:before, h6.md-focus:before {
    color: inherit;
    border: inherit;
    border-radius: inherit;
    position: inherit;
    left: initial;
    float: none;
    top: initial;
    font-size: inherit;
    padding-left: inherit;
    padding-right: inherit;
    vertical-align: inherit;
    font-weight: inherit;
    line-height: inherit;
}
.sidebar-content {
    counter-reset: h1
}
 
.outline-h1 {
    counter-reset: h2
}
 
.outline-h2 {
    counter-reset: h3
}
 
.outline-h3 {
    counter-reset: h4
}
 
.outline-h4 {
    counter-reset: h5
}
 
.outline-h5 {
    counter-reset: h6
}
 
.outline-h1>.outline-item>.outline-label:before {
    counter-increment: h1;
    content: counter(h1) ". "
}
 
.outline-h2>.outline-item>.outline-label:before {
    counter-increment: h2;
    content: counter(h1) "." counter(h2) ". "
}
 
.outline-h3>.outline-item>.outline-label:before {
    counter-increment: h3;
    content: counter(h1) "." counter(h2) "." counter(h3) ". "
}
 
.outline-h4>.outline-item>.outline-label:before {
    counter-increment: h4;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) ". "
}
 
.outline-h5>.outline-item>.outline-label:before {
    counter-increment: h5;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) ". "
}
 
.outline-h6>.outline-item>.outline-label:before {
    counter-increment: h6;
    content: counter(h1) "." counter(h2) "." counter(h3) "." counter(h4) "." counter(h5) "." counter(h6) ". "
}



</style><title>JVM--Java虚拟机简单介绍</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><blockquote><p><span>首先，如果需要真正深入了解jvm的内部情况，可以登录java的官网下载对应版本的</span><a href='https://docs.oracle.com/javase/specs/index.html' title='规范'><span>规范</span></a><span>，可下载对应的pdf文件做详细了解。也可以阅读《深入理解Java虚拟机：JVM高级特性与最佳实践》。</span></p></blockquote><blockquote><p><span>本文主要为读者描绘jvm的大致情况，方便读者在之后的学习中有方向性地了解更细节的内容。主要基于当前常用的JAVA8。</span></p></blockquote><blockquote><p><span>java虚拟机规范并不是关于虚拟机的实现，而是介绍了一些规则，因此读者会发现为什么虚拟机还有什么hotspot之类。并且由于虚拟机对应的时class文件，因此其它语言可以依赖自己的编译器获得一个可以运行在java虚拟机上的文件。</span></p></blockquote><table><tbody><tr><td bgcolor="yellow">本文内容较杂，但由浅入深，将各部分知识敲碎再组合。适合一次性读完。</td></tr></tbody></table><div class='md-toc' mdtype='toc'><p class="md-toc-content" role="list"><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n9"><a class="md-toc-inner" href="#虚拟机主要内容">虚拟机主要内容</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n57"><a class="md-toc-inner" href="#类加载">类加载</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n58"><a class="md-toc-inner" href="#简要概述">简要概述</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n71"><a class="md-toc-inner" href="#加载过程">加载过程</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n91"><a class="md-toc-inner" href="#内存管理">内存管理</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n93"><a class="md-toc-inner" href="#内存公有区">内存公有区</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n111"><a class="md-toc-inner" href="#内存私有区">内存私有区</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n132"><a class="md-toc-inner" href="#垃圾回收器gc）">垃圾回收器（GC）</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n199"><a class="md-toc-inner" href="#对象存储-1">对象存储</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n201"><a class="md-toc-inner" href="#实例存储">实例存储</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n242"><a class="md-toc-inner" href="#对象定位">对象定位</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n260"><a class="md-toc-inner" href="#垃圾回收操作">垃圾回收操作</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n261"><a class="md-toc-inner" href="#前期准备">前期准备</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n309"><a class="md-toc-inner" href="#回收器操作">回收器操作</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n419"><a class="md-toc-inner" href="#class文件结构">Class文件结构</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n468"><a class="md-toc-inner" href="#类加载过程">类加载过程</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n471"><a class="md-toc-inner" href="#类的初始化">类的初始化</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n496"><a class="md-toc-inner" href="#类的加载">类的加载</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n520"><a class="md-toc-inner" href="#对象存储-2">对象存储</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n521"><a class="md-toc-inner" href="#对象存储结构">对象存储结构</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n533"><a class="md-toc-inner" href="#指针压缩">指针压缩</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n578"><a class="md-toc-inner" href="#class文件加载">class文件加载</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n581"><a class="md-toc-inner" href="#自定义的类加载器">自定义的类加载器</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n604"><a class="md-toc-inner" href="#类的验证">类的验证</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n619"><a class="md-toc-inner" href="#class文件加密与解密">class文件加密与解密</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n635"><a class="md-toc-inner" href="#多线程或多并发环境的jvm">多线程或多并发环境的JVM</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n637"><a class="md-toc-inner" href="#对象创建">对象创建</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n690"><a class="md-toc-inner" href="#垃圾回收">垃圾回收</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n728"><a class="md-toc-inner" href="#其它的类加载机制">其它的类加载机制</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n729"><a class="md-toc-inner" href="#tomcat">Tomcat</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n780"><a class="md-toc-inner" href="#字节码生成">字节码生成</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n782"><a class="md-toc-inner" href="#模块化">模块化</a></span><span role="listitem" class="md-toc-item md-toc-h1" data-ref="n785"><a class="md-toc-inner" href="#附录">附录</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n786"><a class="md-toc-inner" href="#class文件3des加密和解密自定义的类加载器）">class文件3DES加密和解密（自定义的类加载器）</a></span><span role="listitem" class="md-toc-item md-toc-h2" data-ref="n788"><a class="md-toc-inner" href="#调优">调优</a></span><span role="listitem" class="md-toc-item md-toc-h3" data-ref="n1067"><a class="md-toc-inner" href="#可视化">可视化</a></span></p></div><h1 id='虚拟机主要内容'><span>虚拟机主要内容</span></h1><ul><li><p><span>首先，从代码运行开始，虚拟机需要加载class文件，此时需要依赖类加载器。</span></p><ol start='' ><li><span>由于类既有Java自带的类，还有用户定义的类，以及一些特殊场景下需要特别照顾的类。</span></li><li><span>于是，虚拟机内部包含多种类加载器，同时用户也可以为特殊场景定义自己的类加载器。</span></li></ol></li><li><p><span>在类加载之后，就到了内存之中。内存管理则是一个大内容。</span></p><ul><li><p><span>首先，宏观上，内存包含了以下两类，公有区和私有区：</span></p><ul><li><p><font color=Blue><span>公有区：</span></font></p><ol start='' ><li><span>堆(heap)</span></li><li><span>元空间【方法区（这是逻辑概念)】(MetaSpace)</span></li></ol></li><li><p><font color=Blue><span>私有区：</span></font></p><ol start='' ><li><span>虚拟机栈：将为线程分配对应的私有栈</span></li><li><span>本地方法栈</span></li><li><span>程序计数器</span></li></ol></li></ul></li><li><p><span>其次，垃圾回收器（GC)用于垃圾对象占用内存的回收</span></p><ul><li><font color=Orange><span>垃圾回收算法</span></font></li><li><font color=Orange><span>现有主流垃圾回收器</span></font></li></ul></li></ul></li><li><p><span>对象创建流程</span></p><ul><li><p><span>首先将对应的class文件内容加载到方法区中，【在hotspot中，先生成一个对应的c++对象，之后在堆中生成实际的java对象】</span></p><ul><li><span>实际上，对象名在调用对象时，首先指向c++对象，该对象中包含着对Java对象的指针。</span></li></ul></li><li><p><span>java对象的保存是在堆中，但内部仍然包含一系列选择，包含栈存储，TLAB，Eden,S1/S0,Old</span></p></li></ul></li></ul><p><a href='https://imgtu.com/i/WgTZM4'><img src="https://z3.ax1x.com/2021/07/25/WgTZM4.png" referrerpolicy="no-referrer" alt="WgTZM4.png"></a></p><h1 id='类加载'><span>类加载</span></h1><h2 id='简要概述'><span>简要概述</span></h2><p><span>所谓类加载，是指将class文件加载到内存中，由JVM对数据做校验、解析、初始化，最终得到java类型。而class文件本身是按照规范的一组指令的有序集合。</span></p><blockquote><p><span>类加载是在运行期间完成，而不是c++那种提前编译，导致运行效率相对低，但是由此我们可以在运行期间对class文件做操作，更具灵活性和扩展性。例如cglib的动态代理，就是在运行期间完成一个代理对象的class实现并加载的内存中替代原有对象，实现功能增强。</span>
<span>更厉害的是，Alibaba的arthas软件，可以在项目运行期间，替换其中的某个class文件【避免小问题导致的项目整体停止】，这些是提前编译完全做不到的。</span></p></blockquote><p><span>------------------------------------------------------------已有的类加载器-------------------------------------------------------------------------</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="text"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="text"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">BootstrapClassLoader(最底层)【实际是由c++实现的(针对hotspot)】</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">ExtClassLoader（扩展类）</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">AppClassLoader</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 69px;"></div><div class="CodeMirror-gutters" style="display: none; height: 69px;"></div></div></div></pre><p><span>例如，我们希望创建一个HashMap的对象，由于这种属于jdk较为底层的类，不是你开发者可以随便搞的，也算不上是扩展的，就需要交由BootstrapClassLoader负责创建，类似地，不同层级的类由对应的加载器负责。</span>
<span>如此划分，加载器能够各司其职，防止底层的类被后来的类覆盖。同时，如果项目过大，包含了众多的依赖或模块，出现多个类的全限定名相同，这一机制能保证只有一个类能实现，而不是出现多个造成歧义。</span></p><blockquote><p><span>各加载器的加载路径获得方式：</span>
<span>BootstrapClassLoader：System.getProperty(&quot;sun.boot.class.path&quot;)</span></p></blockquote><blockquote><p><span>ExtClassLoader：System.getProperty(&quot;java.ext.dirs&quot;)</span>
<span>AppClassLoader:System.getProperty(&quot;java.class.path&quot;)</span></p></blockquote><blockquote><p><span>通过路径可获悉不同加载器负责的类的范围。其中ext可以在本地安装路径中的jre\lib\ext中看到不少jar文件。</span></p></blockquote><h2 id='加载过程'><span>加载过程</span></h2><blockquote><p><span>类的加载需要先查找现有的类，再创建没有的类</span></p></blockquote><p><span>每个加载器有自己的缓存保存已创建的类。</span>
<span>当一个类需要加载时，首先到达AppClassLoader中，由它查找自身管理的类中是否有现成，则直接返回，否则询问ExtClassLoader，由它再查找它管理的类中是否有现成的，类似地，到达bootBootstrapClassLoader，当发现没有的现成的，它将看看这个类是否是由它负责的，则创建并返回，否则把任务交给ExtClassLoader，类似地，再传递给AppClassLoader，总会在这里创建出来的。</span>
<span>---------这一过程被称为双亲委派机制【就是可以向上或向下踢皮球】</span></p><blockquote><p><em><span>双亲委派机制只是JVM的一种推荐做法，实际的一些实现可能有自己的加载方式，可以了解一下Tomcat的方式，所有的类都会自行加载，只有实现不了才会委派上层完成。</span></em></p></blockquote><blockquote><p><span>如果学习过spring系列，或操作过动态代理的同学，估计会注意到有时参数需要传递一个类的class对象或赋予一个类加载器作为参数。</span>
<span>即使用方法getclassloader()获得，通过这个方法可以获悉对象是由哪个加载的，进一步的getParent()可以得知加载器的上层是哪个。但是在查询ExtClassLoader的父加载器时，返回的是null【因为前文告知了，hotspot最底层的加载器是c++实现的，没有对应的java代码】（常用的JVM多是HotSpot，它本身是c++编写的，而其它JVM，如MRP、Maxine是Java编写的，对应的bootstrap则不为null)</span></p><p><span>【BootstrapClassLoader是与对应的JVM为一个整体，而其它类加载器则属于后来者】</span></p></blockquote><p><span>另外加载器可以实现自定义，jdk中关于加载器的定义的是：</span></p><ol start='' ><li><span>除bootstrap】均继承自ClassLoader抽象类</span></li><li><span>下面有SecureClassLoader实现类</span></li><li><span>再下面有URLClassLoader类</span></li><li><span>再下面就有了AppClassLoader、ExtClassLoader类，可以继承自上面的类自定义加载器。</span></li></ol><p><font color=Red><span>【需要注意的是，类的继承关系，和踢皮球的关系可不相同，新定义的类加载器无论继承自谁，它的parent都是AppClassLoader。】</span></font></p><h1 id='内存管理'><span>内存管理</span></h1><p><span>这里主要先介绍内存的各个组成部分的作用。</span></p><h2 id='内存公有区'><span>内存公有区</span></h2><ul><li><p><span>元空间（方法区）：方法区本身是逻辑概念，相当于接口，是由永久代或元空间实现出来的，由于这个区域没有垃圾回收，因此可以适当调大一些，防止报OutOfMemoryError：Java heap space。</span></p><ul><li><span>主要负责存储：类信息、运行时常量池、静态变量、即时编译器编译后的代码</span></li></ul></li><li><p><span>堆：包含多个部分，Eden、S0/S1(From Survior,To SUrvior)、Old(老年代)。主要存储实例对象，包括数组之类的。【-Xmx,-Xms负责调节堆的大小】</span></p><ul><li><p><span>实例对象生成后，将放在堆中，位置顺序是，Eden-&gt;S0&lt;--&gt;S1-&gt;老年代。</span></p><blockquote><p><span>方法中的字符串都是直接放在这里</span></p></blockquote></li></ul></li></ul><blockquote><p><del><span>jdk1.7实现的方法区称为永久代，1.8则实现为元空间，本质上是与堆保存在一起，但概念上有所差别（jdk1.7合并给堆）【1.7之前，hotSpot称之为永久代】，如果需要调整该区域的内存大小，可用jvm命令【-XX:MaxMetaspaceSize=..】（这是1.8的命令，之前的版本估计也没人在乎）</span></del></p></blockquote><p><span>堆的内存分配比例：</span></p><table border="0" bordercolor="black" width="300" cellspacing="0" cellpadding="0"><tbody><tr><td>老年代</td><td colspan="3">新生代</td></tr><tr><td>2/3</td><td colspan="3">1/3</td></tr><tr><td></td><td>Eden</td><td>S0</td><td>S1</td></tr><tr><td></td><td>80%</td><td>10%</td><td>10%</td></tr></tbody></table><blockquote><p><span>直接内存，这是不属于JVM的内存，主要由java的NIO方法操作，效率高。比如nio中有空拷贝的概念，就是利用一块直接内存存储需要放入磁盘中的数据，【因为磁盘中的对应的位置只需要被覆盖即可，因此不需要实际加载到内存中，因此只需要一个IO操作即可】</span></p></blockquote><h2 id='内存私有区'><span>内存私有区</span></h2><p><span>由于现在的系统以及程序要求多线程，导致需要为不同的线程分配特有的空间进行独立运行。于是，需要分出这样一块内存用于划分成多个独立的小块。</span></p><p><span>每个小块内部包含虚拟机栈、本地方法栈以及程序计数器。</span></p><ul><li><p><span>虚拟机栈：本身是一个栈，内部保存的是进程的局部变量和临时结果。内部每个方法又有独立的栈帧。</span></p><ul><li><p><span>栈帧内部包含：局部变量表，返回地址（方法结束位置），操作数栈，动态链接。</span></p><ol start='' ><li><p><span>局部变量表中，引用类型保存为对应实例的地址。变量表由变量槽（slot）为单位计算大小。</span></p></li><li><p><span>操作数栈，用于执行方法对变量的计算操作。不过是将变量表中的数据进行入栈/出栈操作。（栈的运行深度有限制，否则产生StackOverFlowError，主要取决于给定的内存大小，可通过命令-Xss指定内存大小，IDEA中，可在运行配置中找到VM option选项填写命令，更多常用的配置命令可看一下</span><a href='https://help.aliyun.com/document_detail/148851.html'><span>阿里的文档</span></a><span>）</span></p></li><li><p><span>动态链接，一些方法中的常量在运行时常量池或对应方法在元空间中的地址，或对应字符串的地址，用于调用。主要是hotSpot中的C++负责实现。</span></p><blockquote><p><span>需要额外说明的是，运行时常量池是在元空间中，或称之为方法区。jdk1.6及之前，字符串常量池包含在运行时常量池，但之后，字符串常量池划分到堆中。【字符串的移动，本质是为了称为共享而节省空间】</span></p></blockquote></li><li><p><span>若栈在运行期间需要扩展时，发现无法提供足够的空间，则会产生OutOfMemoryError。</span></p></li></ol><blockquote><p><span>因为方法中的常量在编译时是作为符号引用，因为没有正式落入内存中，就指定个符号说明这个就是那个常量</span></p><blockquote><p><span>就是因为是常量，是不太会变动的，才给一个符号作为引用，其它的普通变量朝生夕死，以一通操作之后，就无人关心它的死活，自认没有要还专门给个符号标记</span></p></blockquote><p><span>所以，其它那些普通变量，就放到了局部变量表中，包括方法中定义的对象实例。也是将对应的地址作为变量放入表中。</span></p></blockquote></li></ul></li><li><p><span>本地方法栈:这个栈实际与虚拟机栈是非常类似的，虽然给出了差别介绍，但实际的jvm将二者视为一体。只是，Java中有些内部的方法或可以自定义一些方法，它们的底层实现可以是其它语言，Java中有一些底层方法是由C/C++实现，并在方法前标记为native方法。包含这类native方法的将交由本地方法栈负责</span></p></li><li><p><span>程序计数器的值是由字节码执行引擎进行修改，毕竟就是它负责执行的。</span></p></li></ul><p><span>【虚拟机栈和本地方法栈有时直接统称Java栈】</span></p><h1 id='垃圾回收器gc）'><span>垃圾回收器（GC）</span></h1><p><span>GC的内容的内容较多，内部包含很多机制和算法，但真正需要做的就是对利用回收器做调优。</span></p><ul><li><p><span>首先，判断垃圾</span></p><ol start='' ><li><p><span>这是一个非常老掉牙的知识点：</span></p><ul><li><p><span>主要是，最初有一个引用计数法，当一个实例对象的身上带有的引用数量不为0，则代表它仍有用，则不视为垃圾，</span><font color=Red ><span>但实际上可以有垃圾抱团的现象</span></font><span>；</span></p></li><li><p><span>实际使用的</span><font color=Blue><span>根可达性方法</span></font><span>。</span></p><ul><li><p><span>由于程序的运行通常从GC root作为入口进入，那么从这个入口开始，内部开始产生多个对象（这里我们姑且称之为main对象），而这些对象之后可能会使用另外一些对象，如调用一些外部方法之类的，总之，之后产生的所有对象都与这些main对象有着引用关系。</span></p></li><li><p><span>更具体一些，GC root可以是：</span></p><blockquote><ul><li><span>虚拟机栈引用的对象、</span></li><li><span>方法区中类静态属性引用的对象、</span></li><li><span>方法区中常量引用的对象、</span></li><li><span>本地方法栈中JNI（即通常所说的Native方法）引用的对象、</span></li><li><span>Java虚拟机内部的引用、</span></li><li><span>所有被同步锁（synchronized关键字）持有的对象、</span></li><li><span>反映Java虚拟机内部情况的JMXBean、JVMTI中注册的回调、本地代码缓存等</span></li></ul></blockquote><blockquote><p><span> </span><sub><span>类似于Java类的引用类型静态变量，字符串常量池里的引用，基本数据类型对应的Class对象，一些常驻的异常对象（比如NullPointExcepiton、OutOfMemoryError）等，还有系统类加载器</span></sub><span> </span></p></blockquote><blockquote><p><span>另外，也会有其它可能的对象称为gc root。如</span></p><blockquote><p><span>分代收集和局部回收（Partial GC），如果只针对Java堆中某一块区域发起垃圾收集时（如最典型的只针对新生代的垃圾收集），必须考虑到内存区域是虚拟机自己的实现细节（在用户视角里任何内存区域都是不可见的），更不是孤立封闭的，所以某个区域里的对象完全有可能被位于堆中其他区域的对象所引用，这时候就需要将这些关联区域的对象也一并加入GC Roots集合中去，才能保证可达性分析的正确性。</span></p></blockquote></blockquote></li></ul></li><li><p><span>引用分类：</span></p><ol start='' ><li><span>强引用：传统的引用</span></li><li><span>软引用：连接那些不必要但可以有用的对象。如果将要发生内存溢出时，将回收这部分对象。SoftReference类</span></li><li><span>弱引用：更弱，对象只能生存到下次垃圾回收。WeakReference</span></li><li><span>虚引用：近乎不存在，无法用过这个引用获得对象实例，只是为了在回收了该对象后有一个系统通知。PhantomRefernce。</span></li></ol></li><li><p><span>起死回生：通常一个对象和其它对象无关后，即开始作为一个垃圾存在，如果它的finalize()方法没有覆盖或没有调用，就直接放到F-Queue中，被JVM再标记一遍。</span></p><ul><li><span>但是，如果它的finalize()有覆盖，还调用了，那在这个方法中，可能会和其它对象建立联系，起死回生。</span></li></ul></li></ul></li><li><p><span>jvm内部保存着所有的对象，从main对象开始，按照引用关系，一步步向下搜索，只要被搜索到，即视为有用的对象，而其它对象自然是垃圾。</span></p></li></ol></li><li><p><span>识别到垃圾对象后，需要做的就是回收垃圾</span></p><ul><li><p><span>实际的垃圾回收，也是一个老掉牙的知识点了。</span></p><ul><li><span>1、标记清除：顾名思义地，记录哪些是垃圾，之后直接回收垃圾的内存，会造成大量内存碎片。</span></li><li><span>2、复制清除：耗费内存，直接将原有的内存划为两半，一半将另一半有用的对象直接复制过来，对面的内存直接变成整个空闲内存。</span></li><li><span>3、标记压缩：（又叫标记-整理）标记清除的同时，将碎片整理起来，速度慢。</span></li><li><span>4、分代回收：就是我们JVM使用的算法，新生代中包含了Eden区和S0/S1，其中S0和S1使用的是复制清除算法，而另外的老年代即Old区，则使用标记-清除或整理算法。</span></li></ul><blockquote><p><del><span>需要告知的是，由于回收垃圾可能会影响程序的运行效率，jvm并不是发现垃圾就回收，即使有一些方法表面意思是释放对象内存，也只是做个样子，只有在内存真的紧张时，才可能出发垃圾回收机制</span></del></p></blockquote></li></ul></li><li><p><span>垃圾回收器：</span></p><ol start='' ><li><span>经典垃圾回收器：Serial、ParNew、Parallel Scavenge、Serial Old、CMS、Garbage First(G1)</span></li><li><span>低延迟垃圾回收器：Shenandoah、ZGC</span></li><li><span>Epsilon</span></li></ol></li><li><p><span>新生/老年代：在jdk1.8及之前，是做上述堆的划分的。经典回收器也是基于此作相应的设计。</span></p><ul><li><span>新生代就是前面提及的Eden、S0/S1，当对象创建初期大多放在这里</span></li><li><span>老年代就是Old喽！只要对象活得够久或空间够大就可以放在这里。</span></li></ul><blockquote><p><span>空间大小占比，新生代:老年代=1:2</span></p></blockquote></li><li><p><span>如果是新生代的容量不够了，则会触发Minor GC，也可以把它看作是新生代GC，对应的也有负责老年代的Old GC。另外还有G1回收器特有的Mixed GC。前面这些都属于Partial GC。如果整个JVM内存都告急，就会触发Full GC。</span></p></li></ul><hr /><h1 id='对象存储-1'><span>对象存储</span></h1><p><font color=Orange><span>首先要注意，类产生的对象和作为数组的对象在创建机理上是不同的。类对象有类加载器一层层负责，而数组则直接由Bootstrap负责。</span></font><span> 【在JVM规范中，指出了底层的实现中，类对象使用了常用的new，而数组则有自己的newarray等方法】</span></p><h2 id='实例存储'><span>实例存储</span></h2><ul><li><span>虽然过程有所区别，但经历了加载机制和创建过程后，最终都产生了相应的实例对象，并将实例存放在堆【正常来说】中。</span></li></ul><div class="md-diagram-panel md-fences-adv-panel"><svg id="mermaidChart506" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="2282.71875" style="max-width: 502.24px; height: 2322.72px;" viewBox="0 0 502.2398376464844 2282.71875" class="md-require-zoom-fix"><style>#mermaidChart506{font-family:sans-serif;font-size:16px;fill:#333;}#mermaidChart506 .error-icon{fill:#552222;}#mermaidChart506 .error-text{fill:#552222;stroke:#552222;}#mermaidChart506 .edge-thickness-normal{stroke-width:2px;}#mermaidChart506 .edge-thickness-thick{stroke-width:3.5px;}#mermaidChart506 .edge-pattern-solid{stroke-dasharray:0;}#mermaidChart506 .edge-pattern-dashed{stroke-dasharray:3;}#mermaidChart506 .edge-pattern-dotted{stroke-dasharray:2;}#mermaidChart506 .marker{fill:#333333;}#mermaidChart506 .marker.cross{stroke:#333333;}#mermaidChart506 svg{font-family:sans-serif;font-size:16px;}#mermaidChart506 .label{font-family:sans-serif;color:#333;}#mermaidChart506 .label text{fill:#333;}#mermaidChart506 .node rect,#mermaidChart506 .node circle,#mermaidChart506 .node ellipse,#mermaidChart506 .node polygon,#mermaidChart506 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaidChart506 .node .label{text-align:center;}#mermaidChart506 .node.clickable{cursor:pointer;}#mermaidChart506 .arrowheadPath{fill:#333333;}#mermaidChart506 .edgePath .path{stroke:#333333;stroke-width:1.5px;}#mermaidChart506 .flowchart-link{stroke:#333333;fill:none;}#mermaidChart506 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaidChart506 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaidChart506 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaidChart506 .cluster text{fill:#333;}#mermaidChart506 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:sans-serif;font-size:12px;background:hsl(80,100%,96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaidChart506:root{--mermaid-font-family:sans-serif;}#mermaidChart506:root{--mermaid-alt-font-family:sans-serif;}#mermaidChart506 flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-id1 LE-方法区存放引用" id="L-id1-方法区存放引用" style="opacity: 1;"><path class="path" d="M202.58984375,53L152.58984375,78L152.58984375,103" marker-end="url(#arrowhead1114)" style="fill:none"></path><defs><marker id="arrowhead1114" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id1 LE-id2" id="L-id1-id2" style="opacity: 1;"><path class="path" d="M292.58984375,53L342.58984375,78L342.58984375,103" marker-end="url(#arrowhead1115)" style="fill:none"></path><defs><marker id="arrowhead1115" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id2 LE-id3" id="L-id2-id3" style="opacity: 1;"><path class="path" d="M342.58984375,148L342.58984375,173L343.08984375000006,198.50000610351555" marker-end="url(#arrowhead1116)" style="fill:none"></path><defs><marker id="arrowhead1116" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id3 LE-id4" id="L-id3-id4" style="opacity: 1;"><path class="path" d="M293.2225644690155,451.93271461549995L249.91796875,538.7999877929688L249.91796875,576.2999877929688" marker-end="url(#arrowhead1117)" style="fill:none"></path><defs><marker id="arrowhead1117" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id3 LE-id5" id="L-id3-id5" style="opacity: 1;"><path class="path" d="M392.9571270450396,451.9327228084761L435.26171875,538.7999877929688L435.26171875,576.2999877929688" marker-end="url(#arrowhead1118)" style="fill:none"></path><defs><marker id="arrowhead1118" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id4 LE-id6" id="L-id4-id6" style="opacity: 1;"><path class="path" d="M249.91796875,621.2999877929688L249.91796875,646.2999877929688L250.41796875,671.7999893188476" marker-end="url(#arrowhead1119)" style="fill:none"></path><defs><marker id="arrowhead1119" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id6 LE-分配在TLAB" id="L-id6-分配在TLAB" style="opacity: 1;"><path class="path" d="M204.1048040808338,848.4055715979237L144.0210952758789,931.7187347412109L144.0210952758789,1055.1687316894531" marker-end="url(#arrowhead1120)" style="fill:none"></path><defs><marker id="arrowhead1120" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id6 LE-id7" id="L-id6-id7" style="opacity: 1;"><path class="path" d="M296.7311346872207,848.4055733816269L355.8148422241211,931.7187347412109L356.31484222412115,969.7187377929689" marker-end="url(#arrowhead1121)" style="fill:none"></path><defs><marker id="arrowhead1121" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id7 LE-id8" id="L-id7-id8" style="opacity: 1;"><path class="path" d="M318.4908315440472,1148.7947210093794L277.6507797241211,1223.6187286376953L277.6507797241211,1261.1187286376953" marker-end="url(#arrowhead1122)" style="fill:none"></path><defs><marker id="arrowhead1122" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id7 LE-分配到TLAB" id="L-id7-分配到TLAB" style="opacity: 1;"><path class="path" d="M394.1388550329124,1148.7947249841768L433.9789047241211,1223.6187286376953L433.9789047241211,1261.1187286376953" marker-end="url(#arrowhead1123)" style="fill:none"></path><defs><marker id="arrowhead1123" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id8 LE-id9" id="L-id8-id9" style="opacity: 1;"><path class="path" d="M277.6507797241211,1306.1187286376953L277.6507797241211,1331.1187286376953L277.6507797241211,1356.1187286376953" marker-end="url(#arrowhead1124)" style="fill:none"></path><defs><marker id="arrowhead1124" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id9 LE-tuichu" id="L-id9-tuichu" style="opacity: 1;"><path class="path" d="M252.20209623637953,1401.1187286376953L223.92578125,1426.1187286376953L224.42578125000003,1451.6187316894534" marker-end="url(#arrowhead1125)" style="fill:none"></path><defs><marker id="arrowhead1125" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-tuichu LE-id10" id="L-tuichu-id10" style="opacity: 1;"><path class="path" d="M193.84446770282014,1565.9374120387579L143.6171875,1633.5187225341797L143.6171875,1671.0187225341797" marker-end="url(#arrowhead1126)" style="fill:none"></path><defs><marker id="arrowhead1126" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-tuichu LE-回收其内存" id="L-tuichu-回收其内存" style="opacity: 1;"><path class="path" d="M258.97405528510586,1561.9704576543472L324.14765548706055,1633.5187225341797L324.14765548706055,1671.0187225341797" marker-end="url(#arrowhead1127)" style="fill:none"></path><defs><marker id="arrowhead1127" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id10 LE-idman" id="L-id10-idman" style="opacity: 1;"><path class="path" d="M143.6171875,1716.0187225341797L143.6171875,1741.0187225341797L143.6171875,1788.5187225341797L143.6171875,1836.0187225341797L143.6171875,1925.3687210083008" marker-end="url(#arrowhead1128)" style="fill:none"></path><defs><marker id="arrowhead1128" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-idman LE-id12" id="L-idman-id12" style="opacity: 1;"><path class="path" d="M143.6171875,1970.3687210083008L143.6171875,2072.218719482422L227.38818264007568,2109.718719482422" marker-end="url(#arrowhead1129)" style="fill:none"></path><defs><marker id="arrowhead1129" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id10 LE-id90" id="L-id10-id90" style="opacity: 1;"><path class="path" d="M204.234375,1712.812745740467L292.85078048706055,1741.0187225341797L292.85078048706055,1766.0187225341797" marker-end="url(#arrowhead1130)" style="fill:none"></path><defs><marker id="arrowhead1130" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id90 LE-id11" id="L-id90-id11" style="opacity: 1;"><path class="path" d="M292.85078048706055,1811.0187225341797L292.85078048706055,1836.0187225341797L342.75539634502064,1899.6477004262197" marker-end="url(#arrowhead1131)" style="fill:none"></path><defs><marker id="arrowhead1131" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id11 LE-id12" id="L-id11-id12" style="opacity: 1;"><path class="path" d="M380.88437271118187,2035.2187210083005L380.38437271118164,2072.218719482422L316.1758770942688,2109.718719482422" marker-end="url(#arrowhead1132)" style="fill:none"></path><defs><marker id="arrowhead1132" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id11 LE-id9" id="L-id11-id9" style="opacity: 1;"><path class="path" d="M406.38816203177294,1887.0225103288913L426.88437271118164,1836.0187225341797L426.88437271118164,1788.5187225341797L426.88437271118164,1741.0187225341797L426.88437271118164,1693.5187225341797L426.88437271118164,1633.5187225341797L426.88437271118164,1523.5687255859375L426.88437271118164,1426.1187286376953L335.6507797241211,1397.0797195235668" marker-end="url(#arrowhead1133)" style="fill:none"></path><defs><marker id="arrowhead1133" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id10 LE-等待内存回收" id="L-id10-等待内存回收" style="opacity: 1;"><path class="path" d="M86.95641447368422,1716.0187225341797L24,1741.0187225341797L24,1788.5187225341797L24,1836.0187225341797L24,1947.8687210083008L24,2072.218719482422L24,2132.218719482422L24,2192.218719482422L198.04843521118164,2237.221850415699" marker-end="url(#arrowhead1134)" style="fill:none"></path><defs><marker id="arrowhead1134" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id12 LE-等待内存回收" id="L-id12-等待内存回收" style="opacity: 1;"><path class="path" d="M277.6507797241211,2154.718719482422L277.6507797241211,2192.218719482422L264.14931440353394,2229.718719482422" marker-end="url(#arrowhead1135)" style="fill:none"></path><defs><marker id="arrowhead1135" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(249.91796875,538.7999877929688)" style="opacity: 1;"><g transform="translate(-13.84375,-12.5)" class="label"><rect rx="0" ry="0" width="27.6875" height="25"></rect><foreignObject width="27.6875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>YES</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(435.26171875,538.7999877929688)" style="opacity: 1;"><g transform="translate(-13.0234375,-12.5)" class="label"><rect rx="0" ry="0" width="26.046875" height="25"></rect><foreignObject width="26.046875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>NO</span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(144.0210952758789,931.7187347412109)" style="opacity: 1;"><g transform="translate(-13.84375,-12.5)" class="label"><rect rx="0" ry="0" width="27.6875" height="25"></rect><foreignObject width="27.6875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>YES</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(355.8148422241211,931.7187347412109)" style="opacity: 1;"><g transform="translate(-13.0234375,-12.5)" class="label"><rect rx="0" ry="0" width="26.046875" height="25"></rect><foreignObject width="26.046875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>NO</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(277.6507797241211,1223.6187286376953)" style="opacity: 1;"><g transform="translate(-13.84375,-12.5)" class="label"><rect rx="0" ry="0" width="27.6875" height="25"></rect><foreignObject width="27.6875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>YES</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(433.9789047241211,1223.6187286376953)" style="opacity: 1;"><g transform="translate(-13.0234375,-12.5)" class="label"><rect rx="0" ry="0" width="26.046875" height="25"></rect><foreignObject width="26.046875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>NO</span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(143.6171875,1633.5187225341797)" style="opacity: 1;"><g transform="translate(-24,-12.5)" class="label"><rect rx="0" ry="0" width="48" height="25"></rect><foreignObject width="48" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>仍存活</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(324.14765548706055,1633.5187225341797)" style="opacity: 1;"><g transform="translate(-24,-12.5)" class="label"><rect rx="0" ry="0" width="48" height="25"></rect><foreignObject width="48" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>已结束</span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(380.38437271118164,2072.218719482422)" style="opacity: 1;"><g transform="translate(-13.84375,-12.5)" class="label"><rect rx="0" ry="0" width="27.6875" height="25"></rect><foreignObject width="27.6875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>YES</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(426.88437271118164,1693.5187225341797)" style="opacity: 1;"><g transform="translate(-13.0234375,-12.5)" class="label"><rect rx="0" ry="0" width="26.046875" height="25"></rect><foreignObject width="26.046875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>NO</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(24,1947.8687210083008)" style="opacity: 1;"><g transform="translate(-16,-12.5)" class="label"><rect rx="0" ry="0" width="32" height="25"></rect><foreignObject width="32" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>退出</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(277.6507797241211,2192.218719482422)" style="opacity: 1;"><g transform="translate(-16,-12.5)" class="label"><rect rx="0" ry="0" width="32" height="25"></rect><foreignObject width="32" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>退出</span></div></foreignObject></g></g></g><g class="nodes"><g class="node default" id="flowchart-id1-1336" transform="translate(247.58984375,30.5)" style="opacity: 1;"><rect rx="22.5" ry="22.5" x="-47.625" y="-22.5" width="95.25" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-32,-12.5)"><foreignObject width="64" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">实例产生</div></foreignObject></g></g></g><g class="node default" id="flowchart-方法区存放引用-1337" transform="translate(152.58984375,125.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-66" y="-22.5" width="132" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-56,-12.5)"><foreignObject width="112" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">方法区存放引用</div></foreignObject></g></g></g><g class="node default" id="flowchart-id2-1339" transform="translate(342.58984375,125.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-74" y="-22.5" width="148" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-64,-12.5)"><foreignObject width="128" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">堆中存放实际对象</div></foreignObject></g></g></g><g class="node default" id="flowchart-id3-1341" transform="translate(342.58984375,349.6499938964844)" style="opacity: 1;"><polygon points="151.65,0 303.3,-151.65 151.65,-303.3 0,-151.65" transform="translate(-151.65,151.65)" class="label-container"></polygon><g class="label" transform="translate(0,0)"><g transform="translate(-136,-12.5)"><foreignObject width="272" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">是否发生逃逸或评估对象占用空间过大</div></foreignObject></g></g></g><g class="node default" id="flowchart-id4-1343" transform="translate(249.91796875,598.7999877929688)" style="opacity: 1;"><rect rx="5" ry="5" x="-77.34375" y="-22.5" width="154.6875" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-67.34375,-12.5)"><foreignObject width="134.6875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">尝试在TLAB中存储</div></foreignObject></g></g></g><g class="node default" id="flowchart-id5-1345" transform="translate(435.26171875,598.7999877929688)" style="opacity: 1;"><rect rx="5" ry="5" x="-58" y="-22.5" width="116" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">进入栈上分配</div></foreignObject></g></g></g><g class="node default" id="flowchart-id6-1347" transform="translate(249.91796875,782.7593612670898)" style="opacity: 1;"><polygon points="111.45937500000001,0 222.91875000000002,-111.45937500000001 111.45937500000001,-222.91875000000002 0,-111.45937500000001" transform="translate(-111.45937500000001,111.45937500000001)" class="label-container"></polygon><g class="label" transform="translate(0,0)"><g transform="translate(-91.34375,-12.5)"><foreignObject width="182.6875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">TLAB是否具有足够的空间</div></foreignObject></g></g></g><g class="node default" id="flowchart-分配在TLAB-1349" transform="translate(144.0210952758789,1077.6687316894531)" style="opacity: 1;"><rect rx="0" ry="0" x="-53.34375" y="-22.5" width="106.6875" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-43.34375,-12.5)"><foreignObject width="86.6875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">分配在TLAB</div></foreignObject></g></g></g><g class="node default" id="flowchart-id7-1351" transform="translate(355.8148422241211,1077.6687316894531)" style="opacity: 1;"><polygon points="108.45,0 216.9,-108.45 108.45,-216.9 0,-108.45" transform="translate(-108.45,108.45)" class="label-container"></polygon><g class="label" transform="translate(0,0)"><g transform="translate(-88,-12.5)"><foreignObject width="176" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">对象是否过大且超过阈值</div></foreignObject></g></g></g><g class="node default" id="flowchart-id8-1353" transform="translate(277.6507797241211,1283.6187286376953)" style="opacity: 1;"><rect rx="5" ry="5" x="-52.984375" y="-22.5" width="105.96875" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-42.984375,-12.5)"><foreignObject width="85.96875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">分配到Eden</div></foreignObject></g></g></g><g class="node default" id="flowchart-分配到TLAB-1355" transform="translate(433.9789047241211,1283.6187286376953)" style="opacity: 1;"><rect rx="0" ry="0" x="-53.34375" y="-22.5" width="106.6875" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-43.34375,-12.5)"><foreignObject width="86.6875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">分配到TLAB</div></foreignObject></g></g></g><g class="node default" id="flowchart-id9-1357" transform="translate(277.6507797241211,1378.6187286376953)" style="opacity: 1;"><rect rx="0" ry="0" x="-58" y="-22.5" width="116" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">发生垃圾回收</div></foreignObject></g></g></g><g class="node default" id="flowchart-tuichu-1359" transform="translate(223.92578125,1523.5687255859375)" style="opacity: 1;"><polygon points="72.45,0 144.9,-72.45 72.45,-144.9 0,-72.45" transform="translate(-72.45,72.45)" class="label-container"></polygon><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">实例是否结束</div></foreignObject></g></g></g><g class="node default" id="flowchart-id10-1361" transform="translate(143.6171875,1693.5187225341797)" style="opacity: 1;"><rect rx="5" ry="5" x="-60.6171875" y="-22.5" width="121.234375" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-50.6171875,-12.5)"><foreignObject width="101.234375" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">转移到S0或S1</div></foreignObject></g></g></g><g class="node default" id="flowchart-回收其内存-1363" transform="translate(324.14765548706055,1693.5187225341797)" style="opacity: 1;"><rect rx="0" ry="0" x="-50" y="-22.5" width="100" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-40,-12.5)"><foreignObject width="80" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">回收其内存</div></foreignObject></g></g></g><g class="node default" id="flowchart-idman-1365" transform="translate(143.6171875,1947.8687210083008)" style="opacity: 1;"><rect rx="5" ry="5" x="-68.6171875" y="-22.5" width="137.234375" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-58.6171875,-12.5)"><foreignObject width="117.234375" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">S0或S1内存已满</div></foreignObject></g></g></g><g class="node default" id="flowchart-id12-1367" transform="translate(277.6507797241211,2132.218719482422)" style="opacity: 1;"><rect rx="5" ry="5" x="-55.765625" y="-22.5" width="111.53125" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-45.765625,-12.5)"><foreignObject width="91.53125" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">转移到Old区</div></foreignObject></g></g></g><g class="node default" id="flowchart-id90-1369" transform="translate(292.85078048706055,1788.5187225341797)" style="opacity: 1;"><rect rx="5" ry="5" x="-58" y="-22.5" width="116" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">发生垃圾回收</div></foreignObject></g></g></g><g class="node default" id="flowchart-id11-1371" transform="translate(380.38437271118164,1947.8687210083008)" style="opacity: 1;"><polygon points="86.85000000000001,0 173.70000000000002,-86.85000000000001 86.85000000000001,-173.70000000000002 0,-86.85000000000001" transform="translate(-86.85000000000001,86.85000000000001)" class="label-container"></polygon><g class="label" transform="translate(0,0)"><g transform="translate(-64,-12.5)"><foreignObject width="128" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">是否到达指定寿命</div></foreignObject></g></g></g><g class="node default" id="flowchart-等待内存回收-1377" transform="translate(256.04843521118164,2252.218719482422)" style="opacity: 1;"><rect rx="0" ry="0" x="-58" y="-22.5" width="116" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">等待内存回收</div></foreignObject></g></g></g></g></g></g></svg></div><p><span>对象创建后，具体的存储流程如上图。</span></p><blockquote><p><span>首先是，试图放在方法栈中，其次考虑TLAB，最后分配到熟悉的Eden,S0/S1,Old区。</span></p></blockquote><p><span>下面简单介绍一下上述的一些过程细节：</span></p><ul><li><p><span>为了提高效率，首先试图将对象放在栈中，这里的栈为方法栈。但首先不能过大，否则存不下；其次，由于对象是相应的方法产生的，改对象需要在此对象的控制之下，而不能被其它外部的变量调用，否则则发生了逃逸。</span></p><ul><li><span>由于是放在方法栈中，对象会随着方法的结束而结束，不需要GC，但是发生逃逸则导致方法结束了，对象不应该结束。则破坏了栈的结构。</span></li></ul></li><li><p><span>TLAB(Thread Local Allocation Buffer)【本地分配缓存区】，是线程在Eden区预留的一块内存，空间非常小。</span></p><ul><li><p><span>如果对象够小，且有足够的空间，就直接放在这里。</span></p><ul><li><span>这里还设置了一个阈值，只要超过，就省去中间的环节，直接放在Old区。</span></li><li><span>较大但还可以的，则放在Eden区。</span></li></ul></li></ul></li><li><p><span>Eden区是一个新对象的集中区，基本上新产生的实例都放在这里，而新的实例大多也短命。在系统触发了垃圾回收机制后，仍存活的实例就转移到S0或S1中。</span></p></li><li><p><span>S0/S1，是遵循复制清除的垃圾处理机制，S0/S1就是被一份为二的内存。每次触发了垃圾回收机制，双方就进行转移。</span></p><ul><li><span>并且，每经历依此垃圾回收，或者的实例的寿命就+1。直到到达指定的寿命，实例就会转移到Old区【这里寿命，一般为15】。</span></li><li><span>另外，还有年龄判断。如果S0或S1中，年龄靠前的一批对象，占据的空间大小超过50%，那么比它们大的对象就会转移到Old区。这一操作是在minor GC后触发。</span></li></ul></li><li><p><span>Old区，如果Old区发现自己可用的空间&lt; Eden区中全部对象的和，</span></p><ul><li><span>首先查看担保参数，-XX:-HandlePromotionFailure，jdk8默认是开启的，没开启就直接触发Full GC</span></li><li><span>再计算一下以前Minor GC后，进入的对象的平均大小，如果Old剩余的空间没有这个值大，也会触发Full GC，否则触发Minor GC.</span></li></ul></li></ul><h2 id='对象定位'><span>对象定位</span></h2><p><span>对象的定位，自然需要获取它在内存中的地址，而这个地址则放在Java栈的本地变量表中，但真正获取到对象，这里有两种方式：【为了得到完善的对象信息，我们一方面要获得对象在堆中的数据信息，另一方面要获得方法区中对象的类型信息】</span></p><ul><li><span>句柄访问：这是一种间接方式，堆中可能划分出一块内存作为句柄池，而本地变量表中的地址则指向这个句柄池。句柄池中包含了我们需要的两个信息的指针。【这个方法较慢，但好处在于变量表与实际对象地址是解耦合的，尤其在复制清除算法中，避免了频繁修改变量表中的值】</span></li><li><span>指针访问：这个方法符合我们的预期，它首先指向堆中的对象数据信息，而其中包含了指向方法区中对象类型信息的指针，再到达方法区获取类信息。【这个方法很快，也是hotspot的主要方式】</span></li></ul><blockquote><p><span>由于hotspot底层为c++，需要创造一种数据结构来描述java类与对象的信息。 hotspot中对于类及其对象的描述使用OOP-Klass模型【OOP(Ordinary Object Pointer)描述实例信息，Klass描述类信息，是与对应java类相关的c++对等体】</span></p></blockquote><ul><li><p><span>OOP一定程度上包含了java对象的地址信息</span></p></li><li><p><span>Klass则是一个抽象基类，描述了对应Java类的信息</span></p><ul><li><span>【除了类本身的信息，为了保证多态性，另外维护了一个虚函数表】</span></li></ul></li></ul><p><span>OOP-Klass导致了在hotspot的底层上，调用实例的过程实际上是先到达c++的对等体上，获得了Java对象的地址，再到达堆中实例的位置。</span></p><h1 id='垃圾回收操作'><span>垃圾回收操作</span></h1><h2 id='前期准备'><span>前期准备</span></h2><blockquote><p><span>前面已经简单介绍了垃圾回收器的概况，但只是介绍了大致的思路，具体如何操作，则涉及到垃圾如何记录，以及安全地清除垃圾。</span></p></blockquote><ul><li><p><span>首先是垃圾回收的触发</span></p><p><span>由于假设不同对象的寿命有所区分可划分出了不同的区域，就有了分代收集。</span></p><ul><li><span>Minor Collection：对新生代进行收集，【S0/S1是复制清除】</span></li><li><span>Full Collection：所有。【标记压缩清除】</span></li></ul><p><span>当Eden区内存耗尽，则触发Minor Collection。当老年代已满，则触发Full Colleciton。</span></p></li><li><p><span>查找根节点【又称根节点枚举】，即我们在进行可达性分析首先需要的起始点。</span></p><ul><li><span>这一过程速度较快，但是为了保证一致性，即不能在我们查找根节点的时候，这些节点还在不停变化。【则需要进行快照，而且</span><font color=Red><span>这一过程要求暂停一切用户线程</span></font><span> 】</span></li></ul><blockquote><p>&nbsp;</p></blockquote></li></ul><blockquote><p><span>由于线程是具有一个私有区域，私有区域中又包含了虚拟机栈，虚拟机栈中又包含了局部变量表，局部变量表中又包含了各种引用地址。Hotspot定义一个数据结构（Oop Map)，表示对象内部各偏移量对应的数据类型，以及以及</span><font color=Orange><span>特定位置</span></font><span>栈和寄存器中引用的位置。</span></p></blockquote><ul><li><p><span>通过Oop Map可快速地分析各个引用，但是不能使用过多，否则存储空间成本过大。因此，我们的特定位置就是设定一个</span><mark><span>安全点</span></mark><span>。</span></p><ul><li><p><span>当到达安全点时，线程将不会继续向下执行，直到jvm完成当前的要做的步骤</span></p><ul><li><span>主动式中断：在安全点出设置一个标志，以表明当前是否完成了垃圾收集操作，否则线程将轮询访问该标志</span></li><li><span>抢先式中断</span></li></ul></li><li><p><span>但是，如果一个线程处于休眠状态，而没有进行适当的中断，可能会错过这样的安全点。因此需要额外引入</span><mark><span>安全区域</span></mark></p><ul><li><span>即扩大了指定的代码区域</span></li></ul></li></ul></li><li><p><span>记忆集，前面提到了分代收集，例如收集新生代垃圾时，如何判断这些对象没有被老年代或方法栈中的对象引用着，就需要这样一个记录跨代引用的数据结构。【避免了从头开始遍历所有引用】</span></p><ul><li><p><span>为了优化记忆集的存储和维护成本，需要考虑其记录精度，（字长精度，即处理器的寻址位数，直接记录跨代指针；对象精度，记录的对象中包含一个跨代指针的字段；卡精度，记录一块内存区域，内存中包含对象，对象又包含跨代指针）</span></p><ul><li><span>卡精度是常用方式，又称</span><strong><mark><span>卡表</span></mark></strong><span>。hotspot中用字节数组表示卡表，卡表内的元素为卡页，卡页的值是对应内存地址的起始位置【源码中CARD_TABLE [this address &gt;&gt;9]=0;表示一个卡页负责的范围是2^9字节】</span></li><li><span>一个卡页可以包含多个对象，只要这些对象中有一个具有跨代指针，那么整个卡页被标记为变脏，之后的垃圾回收，只要识别这些变脏的区域并进行扫描即可。</span></li><li><strong><span>注意</span></strong><span>：记忆集是一种抽象概念，可以有不同实现，而卡表只是其中一种具体实现而已。</span></li></ul></li></ul></li></ul><h2 id='回收器操作'><span>回收器操作</span></h2><p><span>前面已经提及理论当前Java自带的10种垃圾回收器，但其中一些并不是直接使用，而是根据分代收集而组合完成工作。其中G1，Shenandoah，ZGC是可以独立使用的，Epsilon稍微特殊。</span></p><div class="md-diagram-panel md-fences-adv-panel"><svg id="mermaidChart507" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="598.5" style="max-width: 677.188px; height: 638.5px;" viewBox="0 0 677.1875 598.5" class="md-require-zoom-fix"><style>#mermaidChart507{font-family:sans-serif;font-size:16px;fill:#333;}#mermaidChart507 .error-icon{fill:#552222;}#mermaidChart507 .error-text{fill:#552222;stroke:#552222;}#mermaidChart507 .edge-thickness-normal{stroke-width:2px;}#mermaidChart507 .edge-thickness-thick{stroke-width:3.5px;}#mermaidChart507 .edge-pattern-solid{stroke-dasharray:0;}#mermaidChart507 .edge-pattern-dashed{stroke-dasharray:3;}#mermaidChart507 .edge-pattern-dotted{stroke-dasharray:2;}#mermaidChart507 .marker{fill:#333333;}#mermaidChart507 .marker.cross{stroke:#333333;}#mermaidChart507 svg{font-family:sans-serif;font-size:16px;}#mermaidChart507 .label{font-family:sans-serif;color:#333;}#mermaidChart507 .label text{fill:#333;}#mermaidChart507 .node rect,#mermaidChart507 .node circle,#mermaidChart507 .node ellipse,#mermaidChart507 .node polygon,#mermaidChart507 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaidChart507 .node .label{text-align:center;}#mermaidChart507 .node.clickable{cursor:pointer;}#mermaidChart507 .arrowheadPath{fill:#333333;}#mermaidChart507 .edgePath .path{stroke:#333333;stroke-width:1.5px;}#mermaidChart507 .flowchart-link{stroke:#333333;fill:none;}#mermaidChart507 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaidChart507 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaidChart507 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaidChart507 .cluster text{fill:#333;}#mermaidChart507 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:sans-serif;font-size:12px;background:hsl(80,100%,96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaidChart507:root{--mermaid-font-family:sans-serif;}#mermaidChart507:root{--mermaid-alt-font-family:sans-serif;}#mermaidChart507 flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"><g class="cluster" id="flowchart-可独立运行-1414" transform="translate(90.9140625,160.5)" style="opacity: 1;"><rect width="165.828125" height="305" x="-82.9140625" y="-152.5"></rect><g class="label" transform="translate(0, -138.5)" id="mermaidChart507Text"><g transform="translate(-40,-12.5)"><foreignObject width="80" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">可独立运行</div></foreignObject></g></g></g></g><g class="edgePaths"><g class="edgePath LS-serial LE-CMS" id="L-serial-CMS" style="opacity: 1;"><path class="path" d="M121.8046875,381.2111561292754L173.828125,399.25L198.828125,399.25L248.0234375,399.25L297.21875,399.25L370.890625,411.0492992992993" marker-end="url(#arrowhead1201)" style="fill:none"></path><defs><marker id="arrowhead1201" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path></marker></defs></g><g class="edgePath LS-serial LE-serialold" id="L-serial-serialold" style="opacity: 1;"><path class="path" d="M121.8046875,363.5144633939508L173.828125,351.75L198.828125,351.75L248.0234375,351.75L297.21875,351.75L398.6796875,351.75L500.140625,351.75L525.140625,351.75L550.140625,351.75L605.7536590189874,428" marker-end="url(#arrowhead1202)" style="fill:none"></path><defs><marker id="arrowhead1202" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path></marker></defs></g><g class="edgePath LS-CMS LE-serialold" id="L-CMS-serialold" style="opacity: 1;"><path class="path" d="M426.46875,415.5L500.140625,415.5L525.140625,415.5L550.140625,415.5L575.86328125,428" marker-end="url(#arrowhead1203)" style="fill:none"></path><defs><marker id="arrowhead1203" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path></marker></defs></g><g class="edgePath LS-parnew LE-serialold" id="L-parnew-serialold" style="opacity: 1;"><path class="path" d="M130.6484375,478.9902949213229L173.828125,485.5L198.828125,485.5L248.0234375,485.5L297.21875,485.5L398.6796875,485.5L500.140625,485.5L525.140625,485.5L550.140625,485.5L575.86328125,473" marker-end="url(#arrowhead1204)" style="fill:none"></path><defs><marker id="arrowhead1204" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path></marker></defs></g><g class="edgePath LS-parnew LE-CMS" id="L-parnew-CMS" style="opacity: 1;"><path class="path" d="M130.6484375,456.22717422029586L173.828125,438L198.828125,438L248.0234375,438L297.21875,438L370.890625,421.6625086625087" marker-end="url(#arrowhead1205)" style="fill:none"></path><defs><marker id="arrowhead1205" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path></marker></defs></g><g class="edgePath LS-paralleS LE-serialold" id="L-paralleS-serialold" style="opacity: 1;"><path class="path" d="M475.140625,568L500.140625,568L525.140625,568L550.140625,568L608.3723404255319,473" marker-end="url(#arrowhead1206)" style="fill:none"></path><defs><marker id="arrowhead1206" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path></marker></defs></g><g class="edgePath LS-parallO LE-paralleS" id="L-parallO-paralleS" style="opacity: 1;"><path class="path" d="M144.765625,568L173.828125,568L198.828125,568L248.0234375,568L297.21875,568L322.21875,568" marker-end="url(#arrowhead1207)" style="fill:none"></path><defs><marker id="arrowhead1207" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 0 0 L 0 0 z" style="fill: #333"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="translate(248.0234375,399.25)" style="opacity: 1;"><g transform="translate(-24.1953125,-12.5)" class="label"><rect rx="0" ry="0" width="48.390625" height="25"></rect><foreignObject width="48.390625" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span><font color="Red">X</font>JDK9</span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(398.6796875,485.5)" style="opacity: 1;"><g transform="translate(-24.1953125,-12.5)" class="label"><rect rx="0" ry="0" width="48.390625" height="25"></rect><foreignObject width="48.390625" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span><font color="Red">X</font>JDK9</span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g></g><g class="nodes"><g class="node default" id="flowchart-G1-1411" transform="translate(90.9140625,65.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-20.640625" y="-22.5" width="41.28125" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-10.640625,-12.5)"><foreignObject width="21.28125" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">G1</div></foreignObject></g></g></g><g class="node default" id="flowchart-Shenandoah-1412" transform="translate(90.9140625,160.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-57.9140625" y="-22.5" width="115.828125" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-47.9140625,-12.5)"><foreignObject width="95.828125" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Shenandoah</div></foreignObject></g></g></g><g class="node default" id="flowchart-ZGC-1413" transform="translate(90.9140625,255.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-26.265625" y="-22.5" width="52.53125" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-16.265625,-12.5)"><foreignObject width="32.53125" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">ZGC</div></foreignObject></g></g></g><g class="node default" id="flowchart-serial-1397" transform="translate(90.9140625,370.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-30.890625" y="-22.5" width="61.78125" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-20.890625,-12.5)"><foreignObject width="41.78125" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Serial</div></foreignObject></g></g></g><g class="node default" id="flowchart-CMS-1398" transform="translate(398.6796875,415.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-27.7890625" y="-22.5" width="55.578125" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-17.7890625,-12.5)"><foreignObject width="35.578125" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">CMS</div></foreignObject></g></g></g><g class="node default" id="flowchart-serialold-1400" transform="translate(622.1640625,450.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-47.0234375" y="-22.5" width="94.046875" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-37.0234375,-12.5)"><foreignObject width="74.046875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Serial Old</div></foreignObject></g></g></g><g class="node default" id="flowchart-parnew-1403" transform="translate(90.9140625,473)" style="opacity: 1;"><rect rx="5" ry="5" x="-39.734375" y="-22.5" width="79.46875" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-29.734375,-12.5)"><foreignObject width="59.46875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">ParNew</div></foreignObject></g></g></g><g class="node default" id="flowchart-paralleS-1407" transform="translate(398.6796875,568)" style="opacity: 1;"><rect rx="5" ry="5" x="-76.4609375" y="-22.5" width="152.921875" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-66.4609375,-12.5)"><foreignObject width="132.921875" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Parallel Scavenge</div></foreignObject></g></g></g><g class="node default" id="flowchart-parallO-1409" transform="translate(90.9140625,568)" style="opacity: 1;"><rect rx="5" ry="5" x="-53.8515625" y="-22.5" width="107.703125" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-43.8515625,-12.5)"><foreignObject width="87.703125" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Parallel Old</div></foreignObject></g></g></g></g></g></g></svg></div><p><span>上图中，相连的双方代表可以组合使用。（</span><font Color=Red><span>X</span></font><span> JDK9 表示这种组合在JDK9及之后被废弃）</span></p><ul><li><p><span>传统</span></p><ul><li><p><span>Serial：单线程，且必须暂停其它工作线程【Stop The World (STW)】，主要应用与新生代。</span></p><ul><li><span>不先进，但资源要求小。在小规模环境下使用较好。</span></li><li><span>具体操作就是，新生代使用复制清除，老年代使用标记整理。</span></li></ul></li></ul><div class="md-diagram-panel md-fences-adv-panel"><svg id="mermaidChart508" width="1079" xmlns="http://www.w3.org/2000/svg" height="397" viewBox="-8 -8 1079 397" class="md-require-zoom-fix" style="height: 437px;"><style>#mermaidChart508{font-family:sans-serif;font-size:16px;fill:#333;}#mermaidChart508 .error-icon{fill:#552222;}#mermaidChart508 .error-text{fill:#552222;stroke:#552222;}#mermaidChart508 .edge-thickness-normal{stroke-width:2px;}#mermaidChart508 .edge-thickness-thick{stroke-width:3.5px;}#mermaidChart508 .edge-pattern-solid{stroke-dasharray:0;}#mermaidChart508 .edge-pattern-dashed{stroke-dasharray:3;}#mermaidChart508 .edge-pattern-dotted{stroke-dasharray:2;}#mermaidChart508 .marker{fill:#333333;}#mermaidChart508 .marker.cross{stroke:#333333;}#mermaidChart508 svg{font-family:sans-serif;font-size:16px;}#mermaidChart508 .actor{stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:#ECECFF;}#mermaidChart508 text.actor &gt; tspan{fill:black;stroke:none;}#mermaidChart508 .actor-line{stroke:grey;}#mermaidChart508 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaidChart508 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaidChart508 #arrowhead path{fill:#333;stroke:#333;}#mermaidChart508 .sequenceNumber{fill:white;}#mermaidChart508 #sequencenumber{fill:#333;}#mermaidChart508 #crosshead path{fill:#333;stroke:#333;}#mermaidChart508 .messageText{fill:#333;stroke:#333;}#mermaidChart508 .labelBox{stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:#ECECFF;}#mermaidChart508 .labelText,#mermaidChart508 .labelText &gt; tspan{fill:black;stroke:none;}#mermaidChart508 .loopText,#mermaidChart508 .loopText &gt; tspan{fill:black;stroke:none;}#mermaidChart508 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:hsl(259.6261682243,59.7765363128%,87.9019607843%);}#mermaidChart508 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaidChart508 .noteText,#mermaidChart508 .noteText &gt; tspan{fill:black;stroke:none;}#mermaidChart508 .activation0{fill:#f4f4f4;stroke:#666;}#mermaidChart508 .activation1{fill:#f4f4f4;stroke:#666;}#mermaidChart508 .activation2{fill:#f4f4f4;stroke:#666;}#mermaidChart508:root{--mermaid-font-family:sans-serif;}#mermaidChart508:root{--mermaid-alt-font-family:sans-serif;}#mermaidChart508 sequence{fill:apa;}</style><g></g><g><line id="actor2240" x1="75" y1="5" x2="75" y2="388" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">用户线程</tspan></text></g><g><line id="actor2241" x1="275" y1="5" x2="275" y2="388" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="275" dy="0">safePoint1</tspan></text></g><g><line id="actor2242" x1="683" y1="5" x2="683" y2="388" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="608" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="683" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="683" dy="0">GC线程</tspan></text></g><g><line id="actor2243" x1="988" y1="5" x2="988" y2="388" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="913" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="988" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="988" dy="0">safePoint2</tspan></text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0, 0;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0, 0;"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><text x="175" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">运行</text><line x1="75" y1="111" x2="275" y2="111" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="75" y="115" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">1</text><text x="479" y="126" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">(暂停其它线程STW) 对新生代采用复制清除算法</text><line x1="275" y1="161" x2="683" y2="161" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="275" y="165" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">2</text><text x="379" y="176" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">结束STW</text><line x1="683" y1="211" x2="75" y2="211" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="683" y="215" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">3</text><text x="532" y="226" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">运行</text><line x1="75" y1="257" x2="988" y2="257" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="stroke-dasharray: 3, 3; fill: none;"></line><text x="75" y="261" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">4</text><text x="836" y="272" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">STW, 对老年代采用标记整理算法</text><line x1="988" y1="307" x2="683" y2="307" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="stroke-dasharray: 3, 3; fill: none;"></line><text x="988" y="311" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">5</text><g><rect x="0" y="323" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="355.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">用户线程</tspan></text></g><g><rect x="200" y="323" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="355.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="275" dy="0">safePoint1</tspan></text></g><g><rect x="608" y="323" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="683" y="355.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="683" dy="0">GC线程</tspan></text></g><g><rect x="913" y="323" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="988" y="355.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="988" dy="0">safePoint2</tspan></text></g></svg></div><p>&nbsp;</p></li></ul><center>Serial/Serial Old示意图</center><ul><li><p><span>ParNew【简称PN】：多线程并行版Serial</span></p><blockquote><p><span>其中线程的数量默认是当前CPU的核心数，但是可以通过</span><code>-XX:ParallelGCThreads</code><span>指定线程数量，但是没事就别随便改。</span></p><blockquote><p><span>从之前的图中可以看出，只有这个PN可以和CMS做组合，</span></p><ul><li><span>因此一些JDK在</span><code>server</code><span>模式下运行时，会首选这个ParNew</span></li></ul></blockquote></blockquote></li></ul><div contenteditable="false" spellcheck="false" class="mathjax-block md-end-block md-math-block md-rawblock" id="mathjax-n839" cid="n839" mdtype="math_block"><div class="md-rawblock-container md-math-container" contenteditable="false" tabindex="-1"><div class="MathJax_SVG_Display"><span class="MathJax_SVG" id="MathJax-Element-17-Frame" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="97.241ex" height="5.486ex" viewBox="0 -1416.8 41867.7 2362" role="img" focusable="false" style="vertical-align: -1.95ex; margin-bottom: -0.246ex; max-width: 100%;"><defs><path stroke-width="0" id="E76-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path stroke-width="0" id="E76-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path stroke-width="0" id="E76-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path><path stroke-width="0" id="E76-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path stroke-width="0" id="E76-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(40589,0)"><g id="mjx-eqn-1" transform="translate(0,-37)"><use xlink:href="#E76-MJMAIN-28"></use><use xlink:href="#E76-MJMAIN-31" x="389" y="0"></use><use xlink:href="#E76-MJMAIN-29" x="889" y="0"></use></g></g><g transform="translate(12718,0)"><g transform="translate(-15,0)"><g transform="translate(0,-37)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">吞</text><g transform="translate(815,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">吐</text></g><g transform="translate(1630,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">量</text></g><use xlink:href="#E76-MJMAIN-3D" x="2724" y="0"></use><g transform="translate(3502,0)"><g transform="translate(397,0)"><rect stroke="none" width="12759" height="60" x="0" y="220"></rect><g transform="translate(3117,676)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">用</text><g transform="translate(815,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">户</text></g><g transform="translate(1630,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">代</text></g><g transform="translate(2446,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">码</text></g><g transform="translate(3261,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">运</text></g><g transform="translate(4077,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">行</text></g><g transform="translate(4892,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">时</text></g><g transform="translate(5708,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">间</text></g></g><g transform="translate(60,-686)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">用</text><g transform="translate(815,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">户</text></g><g transform="translate(1630,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">代</text></g><g transform="translate(2446,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">码</text></g><g transform="translate(3261,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">运</text></g><g transform="translate(4077,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">行</text></g><g transform="translate(4892,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">时</text></g><g transform="translate(5708,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">间</text></g><use xlink:href="#E76-MJMAIN-2B" x="6746" y="0"></use><g transform="translate(7746,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">垃</text></g><g transform="translate(8561,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">圾</text></g><g transform="translate(9377,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">收</text></g><g transform="translate(10192,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">集</text></g><g transform="translate(11008,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">时</text></g><g transform="translate(11823,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(52.4) matrix(1 0 0 -1 0 0)">间</text></g></g></g></g></g></g></g></g></svg></span></div><script type="math/tex; mode=display" id="MathJax-Element-17">吞吐量=\frac{用户代码运行时间}{用户代码运行时间+垃圾收集时间}</script></div></div><ul><li><p><span>Parallel Scavenge【简称PS】：多线程的新生代收集器。可设定吞吐量相关的参数。</span></p><blockquote><p><span>新生代复制算法，老年代标记-整理算法。</span></p><p><span>该收集器注重的是吞吐量，可使用自适应调节策略将内存管理的优化任务交给虚拟机负责。</span></p><blockquote><p><span>server模式下的默默人收集器。</span></p></blockquote></blockquote></li></ul><ul><li><p><span>Serial Old【简称SO】：单线程，使用标记整理算法，主要用于老年代。</span></p><ul><li><p><span>可作为CMS失败时的后备方案</span></p><blockquote><p><span>Paralle Scavenge内部具有PS MarkSweep收集器进行老年代收集，这一收集器的实现本质上与SO相同。【JDK5及之前】，通常是PS与SO组合使用。</span></p></blockquote></li></ul></li><li><p><span>Parallel Old【简称PO】：Parallel Scavenge的老年代版本，多线程，标记整理算法。【JDK6伊始】。常常优先考虑PS-PO组合</span></p></li><li><p><span>CMS(Concurrent-Marking-Sweep)：着重于低延迟，多线程并发，老年代，标记清除算法。</span></p><blockquote><p><span>是HotSpot真正的并发收集器。</span></p><p><span>缺点：</span></p><blockquote><ul><li><span>对CPU资源敏感</span></li><li><span>无法处理浮动垃圾</span></li><li><span>它的标记清除算法仍会产生大量碎片</span></li><li><span>执行不确定。可能出现上一次的垃圾回收还没结束，这一次的已经开始了。</span></li></ul></blockquote></blockquote><div class="md-diagram-panel md-fences-adv-panel"><svg id="mermaidChart509" width="1251" xmlns="http://www.w3.org/2000/svg" height="581" viewBox="-8 -8 1251 581" class="md-require-zoom-fix" style="height: 621px;"><style>#mermaidChart509{font-family:sans-serif;font-size:16px;fill:#333;}#mermaidChart509 .error-icon{fill:#552222;}#mermaidChart509 .error-text{fill:#552222;stroke:#552222;}#mermaidChart509 .edge-thickness-normal{stroke-width:2px;}#mermaidChart509 .edge-thickness-thick{stroke-width:3.5px;}#mermaidChart509 .edge-pattern-solid{stroke-dasharray:0;}#mermaidChart509 .edge-pattern-dashed{stroke-dasharray:3;}#mermaidChart509 .edge-pattern-dotted{stroke-dasharray:2;}#mermaidChart509 .marker{fill:#333333;}#mermaidChart509 .marker.cross{stroke:#333333;}#mermaidChart509 svg{font-family:sans-serif;font-size:16px;}#mermaidChart509 .actor{stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:#ECECFF;}#mermaidChart509 text.actor &gt; tspan{fill:black;stroke:none;}#mermaidChart509 .actor-line{stroke:grey;}#mermaidChart509 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaidChart509 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaidChart509 #arrowhead path{fill:#333;stroke:#333;}#mermaidChart509 .sequenceNumber{fill:white;}#mermaidChart509 #sequencenumber{fill:#333;}#mermaidChart509 #crosshead path{fill:#333;stroke:#333;}#mermaidChart509 .messageText{fill:#333;stroke:#333;}#mermaidChart509 .labelBox{stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:#ECECFF;}#mermaidChart509 .labelText,#mermaidChart509 .labelText &gt; tspan{fill:black;stroke:none;}#mermaidChart509 .loopText,#mermaidChart509 .loopText &gt; tspan{fill:black;stroke:none;}#mermaidChart509 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:hsl(259.6261682243,59.7765363128%,87.9019607843%);}#mermaidChart509 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaidChart509 .noteText,#mermaidChart509 .noteText &gt; tspan{fill:black;stroke:none;}#mermaidChart509 .activation0{fill:#f4f4f4;stroke:#666;}#mermaidChart509 .activation1{fill:#f4f4f4;stroke:#666;}#mermaidChart509 .activation2{fill:#f4f4f4;stroke:#666;}#mermaidChart509:root{--mermaid-font-family:sans-serif;}#mermaidChart509:root{--mermaid-alt-font-family:sans-serif;}#mermaidChart509 sequence{fill:apa;}</style><g></g><g><line id="actor2244" x1="75" y1="5" x2="75" y2="572" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">用户线程</tspan></text></g><g><line id="actor2245" x1="317.5" y1="5" x2="317.5" y2="572" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="242.5" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="317.5" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="317.5" dy="0">安全点1</tspan></text></g><g><line id="actor2246" x1="517.5" y1="5" x2="517.5" y2="572" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="442.5" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="517.5" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="517.5" dy="0">安全点2</tspan></text></g><g><line id="actor2247" x1="760" y1="5" x2="760" y2="572" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="685" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="760" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="760" dy="0">安全点3</tspan></text></g><g><line id="actor2248" x1="960" y1="5" x2="960" y2="572" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="885" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="960" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="960" dy="0">安全点4</tspan></text></g><g><line id="actor2249" x1="1160" y1="5" x2="1160" y2="572" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1085" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1160" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1160" dy="0">安全点5</tspan></text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0, 0;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0, 0;"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><text x="196" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">运行</text><line x1="75" y1="111" x2="317.5" y2="111" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="75" y="115" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">1</text><text x="418" y="126" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">STW，初始标记</text><line x1="317.5" y1="161" x2="517.5" y2="161" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="317.5" y="165" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">2</text><g><rect x="292.5" y="169" fill="#EDF2AE" stroke="#666" width="250" height="36" rx="0" ry="0" class="note"></rect><text x="418" y="174" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="noteText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 14px; font-weight: 400;"><tspan x="418">仅标记根节点</tspan></text></g><text x="296" y="220" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">结束STW</text><line x1="517.5" y1="255" x2="75" y2="255" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="stroke-dasharray: 3, 3; fill: none;"></line><text x="517.5" y="259" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">3</text><text x="418" y="270" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">运行，并发标记。该过程时间最长。</text><line x1="75" y1="301" x2="760" y2="301" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="75" y="305" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">4</text><g><rect x="50" y="309" fill="#EDF2AE" stroke="#666" width="735" height="36" rx="0" ry="0" class="note"></rect><text x="418" y="314" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="noteText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 14px; font-weight: 400;"><tspan x="418">用一个闭包结构记录可达对象，并跟踪记录引用更新的位置</tspan></text></g><text x="860" y="360" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">STW，重新标记</text><line x1="760" y1="395" x2="960" y2="395" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="760" y="399" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">5</text><text x="518" y="410" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">结束STW</text><line x1="960" y1="445" x2="75" y2="445" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="stroke-dasharray: 3, 3; fill: none;"></line><text x="960" y="449" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">6</text><text x="618" y="460" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">运行，并发清理</text><line x1="75" y1="491" x2="1160" y2="491" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="75" y="495" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">7</text><g><rect x="0" y="507" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="539.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">用户线程</tspan></text></g><g><rect x="242.5" y="507" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="317.5" y="539.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="317.5" dy="0">安全点1</tspan></text></g><g><rect x="442.5" y="507" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="517.5" y="539.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="517.5" dy="0">安全点2</tspan></text></g><g><rect x="685" y="507" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="760" y="539.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="760" dy="0">安全点3</tspan></text></g><g><rect x="885" y="507" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="960" y="539.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="960" dy="0">安全点4</tspan></text></g><g><rect x="1085" y="507" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1160" y="539.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1160" dy="0">安全点5</tspan></text></g></svg></div><ul><li><span>初始标记：仅标记根节点</span></li><li><span>并发标记：正常的从根节点向下遍历，由于此时用户线程不停止，导致结果与最后实际情况有误差</span></li><li><span>重新标记：为修正误差，停止用户线程并修正结果</span></li><li><span>并发清除：收集死亡对象</span></li></ul><blockquote><p><span>默认的回收线程数为</span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.53ex" height="3.511ex" viewBox="0 -1057.4 4533.7 1511.8" role="img" focusable="false" style="vertical-align: -1.055ex;"><defs><path stroke-width="0" id="E77-MJMATHI-43" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path><path stroke-width="0" id="E77-MJMATHI-50" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path><path stroke-width="0" id="E77-MJMATHI-55" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"></path><path stroke-width="0" id="E77-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path><path stroke-width="0" id="E77-MJMAIN-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path stroke-width="0" id="E77-MJMAIN-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(120,0)"><rect stroke="none" width="4293" height="60" x="0" y="220"></rect><g transform="translate(60,483)"><use transform="scale(0.707)" xlink:href="#E77-MJMATHI-43" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="#E77-MJMATHI-50" x="760" y="0"></use><use transform="scale(0.707)" xlink:href="#E77-MJMATHI-55" x="1511" y="0"></use><g transform="translate(1610,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(35.539) matrix(1 0 0 -1 0 0)">核</text></g><g transform="translate(2163,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(35.539) matrix(1 0 0 -1 0 0)">心</text></g><g transform="translate(2716,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(35.539) matrix(1 0 0 -1 0 0)">数</text></g><use transform="scale(0.707)" xlink:href="#E77-MJMAIN-2B" x="4624" y="0"></use><use transform="scale(0.707)" xlink:href="#E77-MJMAIN-33" x="5402" y="0"></use></g><use transform="scale(0.707)" xlink:href="#E77-MJMAIN-34" x="2786" y="-542"></use></g></g></svg></span><script type="math/tex">\frac{CPU核心数+3}{4}</script></p><p><span>核心数较少时，反而影响实际程序性能。</span></p><ul><li><span>增量式并发收集器：（JDK7就已经不提倡）效果一般，类似多任务抢占式运行，利用有限的线程交替执行不同任务，运行反而更慢。</span></li></ul></blockquote><blockquote><p><span>CMS激活，JDK5默认老年代空间到达68%，JDK9默认92%。老年代必须预留一定空间共回收进程使用。否则将并发失败，需冻结用户进程，并启用Serial Old。</span></p></blockquote></li><li><p><span>G1(Garbage-First)：JDK9及之后的默认。一定程度上是CMS的继承者。可收集堆内存任意区域。</span></p><blockquote><p><span>面向服务器场景。针对多处理器和大容量内存机器，具备高吞吐量，能极大满足GC停顿时间的要求。</span></p></blockquote><ul><li><p><span>Region：G1将Java的堆划分为多个独立等大的区域【是垃圾回收的最小单位】，让这些区域根据需要充当Eden或老年代等角色，因此角色也是可以随时变化的【实际仍然是分代收集算法】。数量最多有2048个。</span></p><ul><li><p><span>Humongous：存储大对象【标准：超过Region容量的一半】，超过整个Region容量的对象为超级大对象，将存放在多个Humongous中。</span></p></li><li><p><span>Region大小可通过-XX:G1HeapRegionSize设置，范围为1MB~32MB，2的次幂。</span></p><blockquote><p><span>不过一般是计算</span><span class="MathJax_SVG" tabindex="-1" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.69ex" height="3.511ex" viewBox="0 -1057.4 2019.2 1511.8" role="img" focusable="false" style="vertical-align: -1.055ex;"><defs><path stroke-width="0" id="E107-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path stroke-width="0" id="E107-MJMAIN-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path><path stroke-width="0" id="E107-MJMAIN-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path stroke-width="0" id="E107-MJMAIN-38" d="M70 417T70 494T124 618T248 666Q319 666 374 624T429 515Q429 485 418 459T392 417T361 389T335 371T324 363L338 354Q352 344 366 334T382 323Q457 264 457 174Q457 95 399 37T249 -22Q159 -22 101 29T43 155Q43 263 172 335L154 348Q133 361 127 368Q70 417 70 494ZM286 386L292 390Q298 394 301 396T311 403T323 413T334 425T345 438T355 454T364 471T369 491T371 513Q371 556 342 586T275 624Q268 625 242 625Q201 625 165 599T128 534Q128 511 141 492T167 463T217 431Q224 426 228 424L286 386ZM250 21Q308 21 350 55T392 137Q392 154 387 169T375 194T353 216T330 234T301 253T274 270Q260 279 244 289T218 306L210 311Q204 311 181 294T133 239T107 157Q107 98 150 60T250 21Z"></path></defs><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><g transform="translate(120,0)"><rect stroke="none" width="1779" height="60" x="0" y="220"></rect><g transform="translate(60,483)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(35.539) matrix(1 0 0 -1 0 0)">堆</text><g transform="translate(553,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(35.539) matrix(1 0 0 -1 0 0)">大</text></g><g transform="translate(1106,0)"><text font-family="STIXGeneral, 'PingFang SC', serif" stroke="none" transform="scale(35.539) matrix(1 0 0 -1 0 0)">小</text></g></g><g transform="translate(182,-383)"><use transform="scale(0.707)" xlink:href="#E107-MJMAIN-32"></use><use transform="scale(0.707)" xlink:href="#E107-MJMAIN-30" x="500" y="0"></use><use transform="scale(0.707)" xlink:href="#E107-MJMAIN-34" x="1000" y="0"></use><use transform="scale(0.707)" xlink:href="#E107-MJMAIN-38" x="1499" y="0"></use></g></g></g></svg></span><script type="math/tex">\frac{堆大小}{2048}</script><span>.</span></p></blockquote></li></ul></li><li><p><span>G1中已没有传统的新生代和老年代。而是将所有的Region区域按照回收空间大小以及回收时间设定优先级并进行排列，有效地提高了垃圾回收的效率。【对应的概念还是有的】</span></p><blockquote><p><span>默认年轻代在堆中的占比是5%，</span></p></blockquote></li><li><p><span>Region也需要维护自己的卡表，G1的卡表同时记录了两种形式，我被谁引用了以及我引用了谁</span></p><ul><li><span>这里的卡表是一种哈希表，键值对应指向对象的Region地址，value包含其中对象所在的索引。</span></li><li><span>由于设置的卡表较多，导致G1需要相对较多的空间存储这些信息</span></li></ul></li><li><p><span>TAMS(Top at Mark Start)，Region中包含两个TAMS(pre,next)，pre对应的是在垃圾回收时，该区域内上次扫描开始的位置，next代表这次扫描开始的位置。【则区域内处于TAMS另一侧的】</span></p></li></ul><p><span>G1的大致操作如下：</span></p><ol start='' ><li><span>初始标记：标记根节点</span></li><li><span>并发标记：递归扫描做可达性分析</span></li><li><span>最终标记：对结果做修正</span></li><li><span>筛选回收：【整体上标记整理算法，局部是标记复制算法】首先，根据回收价值和成本，以及用户期望的停顿时间，选择需要回收的区域，将这些Region中存活的对象复制到其它的空Region中，才将原有的Region整体清空。多条收集器线程并行执行。</span></li></ol><div class="md-diagram-panel md-fences-adv-panel"><svg id="mermaidChart510" width="1166" xmlns="http://www.w3.org/2000/svg" height="667" viewBox="-8 -8 1166 667" class="md-require-zoom-fix" style="height: 707px;"><style>#mermaidChart510{font-family:sans-serif;font-size:16px;fill:#333;}#mermaidChart510 .error-icon{fill:#552222;}#mermaidChart510 .error-text{fill:#552222;stroke:#552222;}#mermaidChart510 .edge-thickness-normal{stroke-width:2px;}#mermaidChart510 .edge-thickness-thick{stroke-width:3.5px;}#mermaidChart510 .edge-pattern-solid{stroke-dasharray:0;}#mermaidChart510 .edge-pattern-dashed{stroke-dasharray:3;}#mermaidChart510 .edge-pattern-dotted{stroke-dasharray:2;}#mermaidChart510 .marker{fill:#333333;}#mermaidChart510 .marker.cross{stroke:#333333;}#mermaidChart510 svg{font-family:sans-serif;font-size:16px;}#mermaidChart510 .actor{stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:#ECECFF;}#mermaidChart510 text.actor &gt; tspan{fill:black;stroke:none;}#mermaidChart510 .actor-line{stroke:grey;}#mermaidChart510 .messageLine0{stroke-width:1.5;stroke-dasharray:none;stroke:#333;}#mermaidChart510 .messageLine1{stroke-width:1.5;stroke-dasharray:2,2;stroke:#333;}#mermaidChart510 #arrowhead path{fill:#333;stroke:#333;}#mermaidChart510 .sequenceNumber{fill:white;}#mermaidChart510 #sequencenumber{fill:#333;}#mermaidChart510 #crosshead path{fill:#333;stroke:#333;}#mermaidChart510 .messageText{fill:#333;stroke:#333;}#mermaidChart510 .labelBox{stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:#ECECFF;}#mermaidChart510 .labelText,#mermaidChart510 .labelText &gt; tspan{fill:black;stroke:none;}#mermaidChart510 .loopText,#mermaidChart510 .loopText &gt; tspan{fill:black;stroke:none;}#mermaidChart510 .loopLine{stroke-width:2px;stroke-dasharray:2,2;stroke:hsl(259.6261682243,59.7765363128%,87.9019607843%);fill:hsl(259.6261682243,59.7765363128%,87.9019607843%);}#mermaidChart510 .note{stroke:#aaaa33;fill:#fff5ad;}#mermaidChart510 .noteText,#mermaidChart510 .noteText &gt; tspan{fill:black;stroke:none;}#mermaidChart510 .activation0{fill:#f4f4f4;stroke:#666;}#mermaidChart510 .activation1{fill:#f4f4f4;stroke:#666;}#mermaidChart510 .activation2{fill:#f4f4f4;stroke:#666;}#mermaidChart510:root{--mermaid-font-family:sans-serif;}#mermaidChart510:root{--mermaid-alt-font-family:sans-serif;}#mermaidChart510 sequence{fill:apa;}</style><g></g><g><line id="actor2250" x1="75" y1="5" x2="75" y2="658" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="0" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">用户线程</tspan></text></g><g><line id="actor2251" x1="275" y1="5" x2="275" y2="658" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="200" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="275" dy="0">安全点1</tspan></text></g><g><line id="actor2252" x1="475" y1="5" x2="475" y2="658" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="400" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="475" dy="0">安全点2</tspan></text></g><g><line id="actor2253" x1="675" y1="5" x2="675" y2="658" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="600" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="675" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="675" dy="0">安全点3</tspan></text></g><g><line id="actor2254" x1="875" y1="5" x2="875" y2="658" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="800" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="875" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="875" dy="0">最终标记</tspan></text></g><g><line id="actor2255" x1="1075" y1="5" x2="1075" y2="658" class="actor-line" stroke-width="0.5px" stroke="#999"></line><rect x="1000" y="0" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1075" y="32.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1075" dy="0">筛选回收</tspan></text></g><defs><marker id="arrowhead" refX="5" refY="2" markerWidth="6" markerHeight="4" orient="auto"><path d="M 0,0 V 4 L6,2 Z"></path></marker></defs><defs><marker id="crosshead" markerWidth="15" markerHeight="8" orient="auto" refX="16" refY="4"><path fill="black" stroke="#000000" stroke-width="1px" d="M 9,2 V 6 L16,4 Z" style="stroke-dasharray: 0, 0;"></path><path fill="none" stroke="#000000" stroke-width="1px" d="M 0,1 L 6,7 M 6,1 L 0,7" style="stroke-dasharray: 0, 0;"></path></marker></defs><defs><marker id="sequencenumber" refX="15" refY="15" markerWidth="60" markerHeight="40" orient="auto"><circle cx="15" cy="15" r="6"></circle></marker></defs><text x="175" y="80" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">运行</text><line x1="75" y1="111" x2="275" y2="111" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="75" y="115" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">1</text><text x="375" y="126" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">STW，初始标记</text><line x1="275" y1="161" x2="475" y2="161" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="275" y="165" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">2</text><g><rect x="250" y="169" fill="#EDF2AE" stroke="#666" width="250" height="36" rx="0" ry="0" class="note"></rect><text x="375" y="174" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="noteText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 14px; font-weight: 400;"><tspan x="375">标记根节点</tspan></text></g><text x="275" y="220" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">结束STW</text><line x1="475" y1="255" x2="75" y2="255" class="messageLine1" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="stroke-dasharray: 3, 3; fill: none;"></line><text x="475" y="259" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">3</text><text x="375" y="270" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">运行，并发标记</text><line x1="75" y1="301" x2="675" y2="301" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="75" y="305" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">4</text><g><rect x="50" y="309" fill="#EDF2AE" stroke="#666" width="650" height="36" rx="0" ry="0" class="note"></rect><text x="375" y="314" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="noteText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 14px; font-weight: 400;"><tspan x="375">闭包结构记录可达对象，跟踪引用更新位置</tspan></text></g><text x="775" y="360" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">STW</text><line x1="675" y1="395" x2="875" y2="395" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="675" y="399" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">5</text><g><rect x="1000" y="403" fill="#EDF2AE" stroke="#666" width="150" height="36" rx="0" ry="0" class="note"></rect><text x="1075" y="408" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="noteText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 14px; font-weight: 400;"><tspan x="1075">多回收线程并行</tspan></text></g><text x="975" y="454" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="messageText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 16px; font-weight: 400;">STW</text><line x1="875" y1="489" x2="1075" y2="489" class="messageLine0" stroke-width="2" stroke="none" marker-end="url(#arrowhead)" marker-start="url(#sequencenumber)" style="fill: none;"></line><text x="875" y="493" font-family="sans-serif" font-size="12px" text-anchor="middle" textLength="16px" class="sequenceNumber">6</text><g><rect x="850" y="497" fill="#EDF2AE" stroke="#666" width="250" height="36" rx="0" ry="0" class="note"></rect><text x="975" y="502" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="noteText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 14px; font-weight: 400;"><tspan x="975">对各Region的回收价值和成本做排序</tspan></text></g><g><rect x="850" y="541" fill="#EDF2AE" stroke="#666" width="250" height="36" rx="0" ry="0" class="note"></rect><text x="975" y="546" text-anchor="middle" dominant-baseline="middle" alignment-baseline="middle" class="noteText" dy="1em" style="font-family: &quot;trebuchet ms&quot;, verdana, arial; font-size: 14px; font-weight: 400;"><tspan x="975">根据用户期望的GC停顿时间指定回收计划</tspan></text></g><g><rect x="0" y="593" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="75" y="625.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="75" dy="0">用户线程</tspan></text></g><g><rect x="200" y="593" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="275" y="625.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="275" dy="0">安全点1</tspan></text></g><g><rect x="400" y="593" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="475" y="625.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="475" dy="0">安全点2</tspan></text></g><g><rect x="600" y="593" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="675" y="625.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="675" dy="0">安全点3</tspan></text></g><g><rect x="800" y="593" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="875" y="625.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="875" dy="0">最终标记</tspan></text></g><g><rect x="1000" y="593" fill="#eaeaea" stroke="#666" width="150" height="65" rx="3" ry="3" class="actor"></rect><text x="1075" y="625.5" dominant-baseline="central" alignment-baseline="central" class="actor" style="text-anchor: middle; font-size: 14px; font-weight: 400; font-family: Open-Sans, sans-serif;"><tspan x="1075" dy="0">筛选回收</tspan></text></g></svg></div><p>&nbsp;</p><blockquote><p><span>Mixed GC 是 G1 中特有的概念。一旦老年代占据堆内存的 45%，就要触发 Mixed GC，此时对年轻代和老年代都会进行回收。</span></p><blockquote><p><code>-XX:InitiatingHeapOccupancyPercent</code><span>：设置触发标记周期的 Java 堆占用率阈值，默认值是 45%。这里的Java 堆占比指的是 non_young_capacity_bytes，也就是非新生代的空间，包括 old + humongous</span></p></blockquote></blockquote></li><li><p><span>低延迟</span></p><ul><li><p><span>ZGC：基于Page或ZPage（相当于Region）的堆内存布局，但这里的Region根据动态性，可动态创建和销毁，并且有不同型号的容量。采用了</span><mark><span>染色指针技术</span></mark><span>进行标记。</span></p><ul><li><span>运作过程为：并发标记、并发预备重分配、并发重分配、并发重映射</span></li></ul></li><li><p><span>shenandoah：目前，这一回收器似乎还是只有OpenJDK支持，而Oracle是故意反对的【不是sun自己做的】。</span></p><ul><li><p><span>从代码上看是对G1的继承者。均使用Region概念，以及相同的回收策略。不同点主要在于：</span></p><ul><li><span>支持了并发的整理算法，可与用户线程并发执行</span></li><li><span>默认不使用分代收集</span></li><li><span>废弃了记忆集，而是用连接矩阵记录引用关系</span></li></ul></li><li><p><span>步骤阶段为：初始标记、</span><mark><span>并发标记</span></mark><span>、最终标记、</span><mark><span>并发清理</span></mark><span>、</span><mark><span>并发回收</span></mark><span>、初始引用更新、最终引用更新、</span><mark><span>并发清理</span></mark></p></li></ul></li></ul></li><li><p><span>Epsilon</span></p></li></ul><p>&nbsp;</p><h1 id='class文件结构'><span>Class文件结构</span></h1><p><span>class文件包含的主要内容有：</span></p><p><span>	</span><span>魔数，（副版本号，主版本号），（常量池计数器，常量池），</span></p><p><span>（访问标志，类索引，父类索引，接口计数器，接口表），</span></p><p><span>（字段计数器，字段表），（方法计数器，方法表），（属性计数器，属性表）。</span></p><blockquote><p><span>关于class文件的内部信息，非常繁多，以至于java虚拟机规范专门列出一章讨论，更具体的细节，读者可查看规范，这里仅阐述整体的框架。</span></p></blockquote><ul><li><p><span>魔数(magic)：class文件的头4个字节。仅用于确定是否为一个class文件。【不同文件都具有这样的魔数，Java从class对应的魔数值为“0xCAFEBABE&quot;(咖啡宝贝)】</span></p></li><li><p><span>版本号：魔数之后的2个字节为副版本后，再之后的2个字节为主版本号。主版本号从45开始计算。读者可将自己的class文件读取为16进制【推荐用sublime text打开】，不仅可以发现前面的魔数，也会发现后面对应的版本号，我这里使用的是Java11编译的结果：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang=""><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang=""><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">cafe babe 0000 0037</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>主版本号对应的16进制的37，转换后为10进制的55。副版本号在JDK1.2~JDK12，都固定为0。</span></p></li><li><p><span>常量池计数器：版本号之后的两个字节用于存放常量池的项数，即对应的容量。假如对应的容量值是0x37，即55，但实际容量大小是54，且项数的索引值是1~54。索引值0是作为特殊存在。</span></p></li><li><p><span>常量池：常量池计数器之后便是记录常量池中的各个量。包括如字符串，final常量值的字面量，也包含如全限定名，方法名及其描述符的符号引用（因为java的类是在加载后才知道对应的内存地址，因此符号引用不是指针）</span></p><ul><li><p><span>常量池中的每一个项都是一组包含多个量的组合，规范中称其为表。</span></p><ul><li><span>表的第一个字节便是</span><code>tag</code><span>，标记类型，判断当前的表是何种的字面量，又或是何种的引用</span></li><li><span>之后，不同类型的表内部的组成也不同，根据不同情况，JVM会对表读出字符串或获取方法名等信息，也会有表的内部包含常量池的索引值，可跳转到相应位置读取信息。</span></li></ul></li></ul></li><li><p><span>访问标志：常量池结束之后，就是2个字节的访问标志，用于识别接口或类的访问信息。</span></p><ul><li><span>用于确定对应的是类还是接口，又或是枚举，以及之后出现的模块，同时也确定这是public的还是其它的。</span></li></ul></li><li><p><span>类索引，父类索引：均为2个字节。访问标志后便是类索引，用于确定对应的全限定名称，类中除了java.lang.Object都具有父类索引。</span></p><ul><li><span>全限定名的确定过程大致为，首先自己的2个字节是作为索引值使用，利用该索引值找到一个CONSTANT_Class_info的常量，在常量中再获取一个索引值，定位到一个CONSTANT_Utf8_info常量，内部的字符串便是需要的全限定名称。</span></li></ul></li><li><p><span>接口计数器，接口表：在父类 索引之后就是接口计数器，记录该类实现的接口数量，2个字节。紧随其后，是一组接口索引的集合，索引各自占据2个字节。若未实现接口，则接口计数器为0，不存在接口表。</span></p></li></ul><blockquote><p><span>计数器均占据2个字节</span></p><p><span>下述表中，均会对各个元素做详细 的描述，如方法的访问权限等，总之将代码中的各种信息转化到表中对应符号标志</span></p></blockquote><ul><li><span>字段计数器，字段表：字段表表述当前类的字段，但不包括从接口或父类那继承来的</span></li><li><span>方法计数器，方法表：同样不会描述父类或父接口的方法</span></li><li><span>属性计数器，属性表：</span></li></ul><p>&nbsp;</p><h1 id='类加载过程'><span>类加载过程</span></h1><blockquote><p><span>前文介绍的双亲委派机制，这一机制是jdk1.2之后引入的推荐方法，而不是强制的，具体的实现代码在java.lang.ClassLoader中的loadClass()方法中。</span></p></blockquote><h2 id='类的初始化'><span>类的初始化</span></h2><ul><li><span>另外在加载之后，需要进行连接，这里包含了三个步骤【验证、准备、解析】，之后进行初始化，才能开始使用，如果任务结束，则对类进行卸载。</span><font color=Red><span>其中，为了效率，连接中的一些操作会在加载阶段同步进行</span></font><span>，其中的步骤也不是完全具有先后顺序。</span></li></ul><blockquote><p><span>初始化，主要是处理其中的静态变量和静态代码块</span></p></blockquote><p><span>这里需要注意的是其中的初始化问题，何时需要真正初始化一个类，首先必须有一个类的情况下则必须初始化，如：</span></p><ol start='' ><li><span>new一个对象，使用类的静态字段或方法。反射调用一个类。还有一个是动态语言生成的方法句柄需初始化对应的类。</span></li><li><span>由于对象的继承关系，首先需要初始化其父类。或程序的main函数所在的类也必须初始化。</span></li><li><span>特别的，由于jdk8后接口存在default方法，继承此接口的类初始化，必定带动这个接口初始化。</span></li></ol><p><span>【特别的例子说明】</span></p><ul><li><p><span>如果B继承了A，且二者内部均有各自的静态代码，例如A中有静态变量a,B中有静态语句输出。如果调用了B.a，此时并不会返回B中的静态输出，即没有实现B的初始化（但有可能完成了加载、验证）。</span></p><ul><li><span>因为此时，我们仅需要的是A的静态变量，B虽然出场了，但我们既然开始初始化了A，B是否存在就不重要了，导致B的类不是必须的。</span></li></ul></li><li><p><span>如果我们定义了一个B类型的数组，实际也还是不会有所输出。我们当前只是完成了数组的分配，相当于盖房子，入住手续后面可以进行，没那么急。而且，这个定义的数组本质上也是一个类，是一个继承自Object由JVM自动生成的关于B的类，内部包装了数组操作。</span></p></li><li><p><span>类似地，如果A中的静态变量是一个常量，那么调用A.a时，A是不会初始化的。因为在编译期间，这些常量已提前放到了常量池中。此时这个变量和A有关系，但又不完全有关系。</span></p></li></ul><h2 id='类的加载'><span>类的加载</span></h2><p><span>前一节提前说了一下类的初始化，但这一切的开头都需要类的加载。</span></p><ul><li><span>加载过程：由全限定名称获取字节流，转化为方法区内的运行时数据结构、生成一个java.lang.Class对象作为该类的访问接口。</span></li></ul><p><span>其中的字节流可以通过一切手段获得。例如网络、jar包、数据库等。</span></p><blockquote><p><span>其中的jar包读取，在对应的位置字符串中指明对应的协议和jar包位置，再接上“!/&quot;表明读取包内的文件，之后就是接上对应jar包内文件的位置。如”jar:file:</span><span>\</span><span>\【jar包位置】!/【文件位置】“</span></p></blockquote><p><span>前文中提及了如果有需要的话，可以自定义类加载器。现在，我们就可以继承URLClassLoader，再覆盖对应的类加载方法，包括从哪里读取类文件(其中，就可以用上述jar包读取的方式从自定义的jar包中读取自己的class文件并加载到内存中)。</span></p><p><span>如果我们有多个类似的jar包，但是内部class文件的代码逻辑有所差别【类似于人类的双标行为】，此时就可以通过自定义的类加载器，视情况加载不同的jar包。</span></p><p><font color=Red><span>【需要注意数组】</span></font></p><p><span>需要说明一下数组的组件类型，即数组去掉一个维度后的类型，如String[] 组件类型就是String，而String</span>[][]<span> </span><span>[</span><span> ][ ]的组件类型就是String[]。</span></p><p><span>首先，数组不同于普通java对象，它是直接由JVM创建 ，而不是类加载器完成。就如前面的【特别的例子说明】中提及的，数组是被JVM直接创建了一个对应的类。</span></p><ol start='' ><li><p><span>如果组件类型是String这类的非引用型的，那么就直接交给BootstrapClassLoader进行创建。</span></p></li><li><p><span>否则，就仍然是个数组的引用，</span></p><ul><li><p><span>java8的虚拟机规范中介绍是：此时数组被标记为已由组件类型的定义类加载器定义。</span></p><ul><li><span>但之后，被去掉一个维度的数组再次进入这样一个加载流程中，不断地被去掉一个维度，并不断地被标记，直到最后不再是引用类型，到达BootstrapClassLoader进行创建。</span></li></ul></li></ul></li></ol><h1 id='对象存储-2'><span>对象存储</span></h1><h2 id='对象存储结构'><span>对象存储结构</span></h2><p><span>对象在堆内存的存储布局为：对象头（header），实例数据（Instance Data），对齐填充（Padding）。</span></p><blockquote><p><span>对齐填充是保证对象的大小为8字节的倍数。这与CPU的缓存行有关，使得每次加载后都能立刻被CPU刷新执行，提高效率。【现在一些CPU的缓存行已经较大，如64字节，为了提高效率，一些项目会在对象中故意加若干个long或其它类型的变量以进行主动填充】</span></p></blockquote><p><span>其中对象头中包含了</span><code>mark word</code><span>、</span><code>元数据指针</code><span>，若为数组则另外有一个</span><code>数组长度</code><span>。这些元素的大小均与对应JVM的位数有关，例如64位的JVM，则均为64bit。</span></p><p><span>元数据指针(klass word)则是用于指向方法区中目标类的类型信息，也就是说通过元数据指针可以准确定位到当前对象的具体目标类型。</span></p><p><span>mark word中可以包含大量信息，如锁状态，GC年龄。且占用的空间位数与相应的CPU处理位数相同。</span></p><p><span>32位情况：</span></p><table border="1" cellspacing="0" width="50%" height="150">
<tbody><tr><th rowspan="2">锁状态</th><th colspan="2">25bit</th> <th rowspan="2">4bit</th><th>1bit</th> <th>2bit</th></tr>
<tr><td>23bit</td> <td>2bit</td><td>是否偏向锁</td><td>锁标志位</td></tr>
<tr>
    <td>无锁状态</td>
    <td colspan="2">对象的hashcode</td><td>分代年龄</td><td>0</td><td>01</td>
</tr>
<tr>
	<td>轻量级锁</td><td colspan="4">指向栈中锁记录的指针</td><td>00</td>
</tr>
<tr>
<td>重量级锁</td><td colspan="4">指向互斥量(重量级锁)的指针</td><td>10</td>
</tr>
<tr>
<td>GC标记</td><td colspan="4">空</td><td>11</td>
</tr>
<tr>
<td>偏向锁</td><td>线程ID</td><td>Epoch</td><td>分代年龄</td><td>1</td><td>01</td>
</tr>
</tbody></table><p><span>64位情况：</span></p><p><img src="http://p2pworker.xyz/wp-content/uploads/2021/06/markword64.png" referrerpolicy="no-referrer"></p><p>&nbsp;</p><h2 id='指针压缩'><span>指针压缩</span></h2><ul><li><p><span>对象头</span></p><ul><li><span>32位系统：占用 8 字节(markWord4字节+kclass4字节)</span></li><li><span>64位系统：开启压缩指针时，占用 12 字节，否则是16字节(markWord8字节+kclass8字节，开启时markWord8字节+kclass4字节)</span></li></ul></li><li><p><span>引用类型</span></p><ul><li><span>32位系统：占4字节 (因为此引用类型要去方法区中找类信息,所以地址为32位即4字节同理64位是8字节)</span></li><li><span>64位系统：开启压缩指针时，占用4字节，否则是8字节</span></li></ul></li></ul><blockquote><p><span>如果所使用的 64 位虚拟机的版本在 Update14-Update22 之间，可以通过选项</span></p><p><span>“-XX:+UseCompressedOops”显式开启指针压缩功能，而在 Update23 版本之后，指针压缩功能将会被缺省开启。</span></p><p><span>JDK7及之后是默认开启的。</span></p></blockquote><p><span>以下举例说明对象在64位环境下空间的冗余：</span></p><p><span>		</span><span>32位操作系统 花费的内存空间为：对象头(8字节) + 实例数据(int类型(4字节) + 引用类型(4字节)) +对齐(0字节)</span><span>																</span><span>共16个字节</span></p><p><span>		</span><span>64位操作系统：对象头(16字节) + 实例数据 (int类型(4字节) + 引用类型(8字节))+对齐(4字节)</span></p><p><span>																</span><span>共 32个字节</span></p><p><span>		</span><span>同样的对象需要将近两倍的容量,所以需要开启压缩指针：</span></p><p><span>		</span><span>64位开启压缩指针后：对象头(12字节) + 实例数据(int类型(4字节) + 引用类型(4字节))+对齐(0字节)</span></p><p><span>																</span><span> 共24个字节</span></p><p><strong><span>JVM的实现方式是:</span></strong></p><ul><li><p><span>通过前面填充对齐的了解，我们知道JVM中存储的对象大小均是8字节的倍数，因此我们在定位对象时，不需要考虑对象中间的7个字节，引用的地址只需要是8的倍数就可以完成工作。</span></p></li><li><p><span>在64位的系统中，对象的地址仍然使用32位表示，但是当引用实际被使用时，即进入了寄存器时，则左移3位，变成了35位，可定位32GB的内存空间。</span></p><ul><li><span>为什么不多左移几位呢？那样就要求对象的大小是更多字节的倍数，对齐填充可能占据更多的内存。</span></li></ul></li></ul><blockquote><p><span>因此当堆内存大小超过32GB，就不能使用压缩指针来工作了。</span></p><p><span>而且当堆的大小仅仅略大于32GB，由于指针扩大为两倍，需要消耗更多的空间，可能导致实际能用的空间不如32GB的情况。</span></p></blockquote><p><span>	</span></p><ul><li><span>哪些信息会被压缩？</span>
<span>1.对象的全局静态变量(即类属性)</span>
<span>2.对象头信息:64位平台下，原生对象头大小为16字节，压缩后为12字节</span>
<span>3.对象的引用类型:64位平台下，引用类型本身大小为8字节，压缩后为4字节</span>
<span>4.对象数组类型:64位平台下，数组类型本身大小为24字节，压缩后16字节</span></li><li><span>哪些信息不会被压缩？</span>
<span>1.指向非Heap的对象指针</span>
<span>2.局部变量、传参、返回值、NULL指针</span></li></ul><h1 id='class文件加载'><span>class文件加载</span></h1><p><span>在实际使用中，我们当前线程的类加载默认为AppClassloader。如果我们自定义了一个类加载器从外部的jar包或其它途径读取了一组字节流加载为对应的类，由于当前默认的类加载器对这个类是不做负责的，导致我们无法直接的在代码中用普通的类形式调用相关的方法，只能通过类的newInstance()方法生成一个实例，而实例也只能通过getMethod()方法调用指定的方法，invoke读取结果中的对应数据。</span></p><p><span>可使用当前线程即Thread.currentThread().setContextClassloader()来设置当前需要的类加载器，此时就可以像正常操作那样调用类并使用，但最后作为临时操作【可放在某个方法中，临时改变方便自己的操作，最后该还原】。</span></p><h2 id='自定义的类加载器'><span>自定义的类加载器</span></h2><p><span>下面是摘自官方文档的一些介绍：</span></p><blockquote><p><span>支持并发加载类的类加载器称为</span><em><span>并行能力</span></em><span>类加载器，需要通过调用ClassLoader.registerAsParallelCapable方法在其类初始化时间注册自身【默认情况下， </span><code>ClassLoader</code><span>类注册为并行】（它的子类仍然需要注册自己，如果它们是并行的能力）。</span>
<span>在委托模式不是严格层次化的环境中，类加载器需要并行，否则加载类可能导致死锁，因为加载程序锁定在类加载过程中保持（参见</span><a href='java/java/lang/../../java/lang/ClassLoader.html#loadClass-java.lang.String-'><code>loadClass</code></a><span>方法）。</span></p><p><span>方法</span><a href='java/java/lang/../../java/lang/ClassLoader.html#defineClass-java.lang.String-byte:A-int-int-'><code>defineClass</code></a><span>将字节数组转换为类别</span><code>类</code><span>的实例。 这个新定义的类的实例可以使用</span><a href='java/java/lang/../../java/lang/Class.html#newInstance--'><code>Class.newInstance</code></a><span>创建。</span></p><p><span>类加载器创建的对象的方法和构造函数可以引用其他类。 要确定所引用的类，Java虚拟机调用最初创建该类的类加载器的</span><a href='java/java/lang/../../java/lang/ClassLoader.html#loadClass-java.lang.String-'><code>loadClass</code></a><span>方法。</span></p><p><span>网络类加载器子类必须定义从网络加载类的方法</span><a href='java/java/lang/../../java/lang/ClassLoader.html#findClass-java.lang.String-'><code>findClass</code></a><span>和</span><code>loadClassData</code><span> 。 一旦下载构成类的字节，它应该使用方法</span><a href='java/java/lang/../../java/lang/ClassLoader.html#defineClass-byte:A-int-int-'><code>defineClass</code></a><span>创建一个类实例。 </span></p></blockquote><p><span>上述的官方描述，已经说明了一个类加载中主要的方法，因此我们在自定义时只需要覆盖这些方法即可，主要的步骤包括：</span></p><ol start='' ><li><span>在findClass()中指明类的来源，使之能够读入字节流。这里的操作空间就非常大了，可以从任意地方的任意位置的任意文件中获取流，只要是能够执行的。例如，可以放在某个服务器上的某个目录下的txt文件，只要这个文件磁盘上的内容是class文件的形式即可。这样我们可以随便定义目标文件的后缀名让人无法察觉。</span></li><li><span>在获取了字节流之后，findClass()方法内部需要调用一个defineClass()方法从字节流生成一个类。这也可以自主发挥一下如何搞些奇怪的手段改变字节流搞事。</span></li></ol><p><span>大致的效果是：</span></p><p><span>自定义一个类加载器，</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyClassLoader</span> <span class="cm-keyword">extends</span> <span class="cm-variable">ClassLoader</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//省略</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">findClass</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">name</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">ClassNotFoundException</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">//这里如果继承自URLClassLoader，可以使用url读取网络或本地位置的文件</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">File</span> <span class="cm-variable">file</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">File</span>(<span class="cm-string">"目录"</span><span class="cm-operator">+</span><span class="cm-variable">文件name</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span>{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">bytes</span> <span class="cm-operator">=</span> <span class="cm-variable">getMyClassBytes</span>(<span class="cm-variable">file</span>);<span class="cm-comment">//读取字节流，可自定义读取方法</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>.<span class="cm-variable">defineClass</span>(<span class="cm-variable">name</span>, <span class="cm-variable">bytes</span>, <span class="cm-number">0</span>, <span class="cm-variable">bytes</span>.<span class="cm-variable">length</span>)<span class="cm-comment">//生成类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">c</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">e</span>)</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment">//省略</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 483px;"></div><div class="CodeMirror-gutters" style="display: none; height: 483px;"></div></div></div></pre><p><span>调用类加载器，</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">MyClassLoader</span> <span class="cm-variable">myClassLoader</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">MyClassLoader</span>(); <span class="cm-comment">//我们的类加载器</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">clazz</span> <span class="cm-operator">=</span> <span class="cm-variable">Class</span>.<span class="cm-variable">forName</span>(<span class="cm-string">"类名"</span>, <span class="cm-atom">true</span>, <span class="cm-variable">myClassLoader</span>); </span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-variable-3">Object</span> <span class="cm-variable">obj</span> <span class="cm-operator">=</span> <span class="cm-variable">clazz</span>.<span class="cm-variable">newInstance</span>();<span class="cm-comment">//生成一个原始的类对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-comment">//因为默认发类加载器中并不负责这个类，因此一旦脱离的自定义的类加载器，无法给他一个合适的名分，只能作为纯粹的对象，不能直接调用它原有的各种技能</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 115px;"></div><div class="CodeMirror-gutters" style="display: none; height: 115px;"></div></div></div></pre><p><span>另外，如果定义的类的全限定名与上层的类加载器有冲突，不希望被双亲委派机制交由上级处理，可以覆盖loadClass方法指明当对象为null时，由自定义的加载器负责创建。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">protected</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-def">loadClass</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">name</span>, <span class="cm-variable-3">boolean</span> <span class="cm-variable">resolve</span>)<span class="cm-comment">//name为类的全限定名</span></span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">throws</span> <span class="cm-variable">ClassNotFoundException</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">{</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">getClassLoadingLock</span>(<span class="cm-variable">name</span>)) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">findLoadedClass</span>(<span class="cm-variable">name</span>);<span class="cm-comment">//查看缓存中是否已存在对应的类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">c</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/*try {</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">if (parent != null) {</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">c = parent.loadClass(name, false);</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">} else {</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">c = findBootstrapClassOrNull(name);</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">}</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">} catch (ClassNotFoundException e) {</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">e.printStackTrace();</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">}*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//上述为常用的双亲委派机制</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//我们这里不希望委派</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">c</span> <span class="cm-operator">==</span> <span class="cm-atom">null</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">//直接调用自己的方法生成类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">c</span> <span class="cm-operator">=</span> <span class="cm-variable">findClass</span>(<span class="cm-variable">name</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; <span class="cm-comment">//略</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">c</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 621px;"></div><div class="CodeMirror-gutters" style="display: none; height: 621px;"></div></div></div></pre><hr /><p><span>----------------------------------------</span><mark><font color=Blue><span>【疲倦的话，稍微缓一缓吧！】</span></font></mark><span>----------------------------------</span></p><hr /><h2 id='类的验证'><span>类的验证</span></h2><p><span>在获得了类的字节流后，首先需要判断这是不是一个合格的类文件。</span></p><p><span>验证操作主要有：格式验证、语义分析、操作验证，以及符号引用验证等。</span></p><ul><li><p><span>格式验证主要检查字节码文件的字节流是否是符合class文件的格式要求。</span></p><ul><li><span>这一过程本质上是在在加载阶段就开始运行的。</span></li></ul></li><li><p><span>语义验证是在上述验证结束后，字节流加载到方法区后执行。主要检验是否符合语法</span></p></li><li><p><span>操作验证则是对类的方法审核其不会导致崩溃等问题</span></p></li><li><p><span>符号引用验证，主要是对常量池中的各种符号引用执行验证（这一段实际是发生在解析阶段）【将常量池中所有的符号引用全部转换为直接引用】</span></p></li></ul><h2 id='class文件加密与解密'><span>class文件加密与解密</span></h2><p><span>由于Java生成的class文件非常方便就可以被反编译，一些重要的逻辑如果不希望被人看见，则必须要对class文件进行加密。当然，如果只是想稍微隐藏一下，也可利用前面提及的自定义类加载，让自己的class字节流隐藏在某个地方的某个文件中。【常见的反编译工具为</span><strong><span>jd-gui</span></strong><span>，当然Idea肯定也可以，VsCode安装个插件也没问题】</span></p><p><span>下面的内容主要来源于书本《Java虚拟机精讲》的7.3节。</span></p><p><span>首先，加密算法主要有对称加密和非对称加密。在需要双方互通信息时，主要需要非对称加密，用户将自己的公钥传输过去，对方利用公钥加密自己的内容，用户可以使用私钥解读。而对称加密则使用单一的密钥加密和解密，在传输加密信息时，必须双方均持有密钥，导致密钥分发过程造成不安全。但对于本地使用的文件而言，对称加密就足够了。【更多密码学知识，可参考《图解密码技术》】</span></p><p><span>该书中则使用了对称加密的3DES算法。</span></p><ul><li class='md-task-list-item task-list-item task-list-not-done' ><input type='checkbox' /><p><span>加密过程为：C=Ek3( Dk2( Ek1( P ) ) )。</span></p></li><li class='md-task-list-item task-list-item task-list-not-done' ><input type='checkbox' /><p><span>解密过程为：P=Dk1( EK2( Dk3( C ) ) )。</span></p></li></ul><p><span>Ek()和 Dk()代表 DES 算法的加密和解密过程，K 代表 DES 算法使用的密钥，P 代表明文，C 代表密文。</span></p><p><span> 具体的代码实现如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded md-focus" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap CodeMirror-focused" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 78.5px; left: 198.844px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="" style="position: relative;"><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> &nbsp;<span class="cm-variable">javax</span>.<span class="cm-variable">crypto</span>.<span class="cm-variable">SecretKey</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">crypto</span>.<span class="cm-variable">Cipher</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">javax</span>.<span class="cm-variable">crypto</span>.<span class="cm-variable">spec</span>.<span class="cm-variable">SecretKeySpec</span>;</span></pre><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Use3DES</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable-3">String</span> <span class="cm-variable">ALGORITHM</span> <span class="cm-operator">=</span> <span class="cm-string">"DESede"</span>; <span class="cm-comment">// 定义加密算法,</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//-------------加密-----------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">byte</span>[] <span class="cm-variable">encrypt</span>(<span class="cm-variable-3">byte</span>[] <span class="cm-variable">key</span>, <span class="cm-variable-3">byte</span>[] <span class="cm-variable">src</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SecretKey</span> <span class="cm-variable">deskey</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">SecretKeySpec</span>(<span class="cm-variable">key</span>, <span class="cm-variable">ALGORITHM</span>);<span class="cm-comment">// 生成秘钥 key</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Cipher</span> <span class="cm-variable">cipher</span> <span class="cm-operator">=</span> <span class="cm-variable">Cipher</span>.<span class="cm-variable">getInstance</span>(<span class="cm-variable">ALGORITHM</span>);<span class="cm-comment">//对目标数据执行加密操作</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cipher</span>.<span class="cm-variable">init</span>(<span class="cm-variable">Cipher</span>.<span class="cm-variable">ENCRYPT_MODE</span>, <span class="cm-variable">deskey</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">cipher</span>.<span class="cm-variable">doFinal</span>(<span class="cm-variable">src</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">value</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//--------------解密-----------------------------</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">byte</span>[] <span class="cm-variable">decrypt</span>(<span class="cm-variable-3">byte</span>[] <span class="cm-variable">key</span>, <span class="cm-variable-3">byte</span>[] <span class="cm-variable">src</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">SecretKey</span> <span class="cm-variable">deskey</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">SecretKeySpec</span>(<span class="cm-variable">key</span>, <span class="cm-variable">ALGORITHM</span>);<span class="cm-comment">/* 生成秘钥 key */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/* 对目标数据执行解密操作 */</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">Cipher</span> <span class="cm-variable">cipher</span> <span class="cm-operator">=</span> <span class="cm-variable">Cipher</span>.<span class="cm-variable">getInstance</span>(<span class="cm-variable">ALGORITHM</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">cipher</span>.<span class="cm-variable">init</span>(<span class="cm-variable">Cipher</span>.<span class="cm-variable">DECRYPT_MODE</span>, <span class="cm-variable">deskey</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">cipher</span>.<span class="cm-variable">doFinal</span>(<span class="cm-variable">src</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">value</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> &nbsp;<span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">key</span> <span class="cm-operator">=</span> <span class="cm-string">"01234567899876543210abcd"</span>.<span class="cm-variable">getBytes</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">encoded</span> <span class="cm-operator">=</span> <span class="cm-variable">encrypt</span>(<span class="cm-variable">key</span>,</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-string">"测试数据..."</span>.<span class="cm-variable">getBytes</span>(<span class="cm-string">"utf-8"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"加密后的数据-&gt;"</span> <span class="cm-operator">+</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>(<span class="cm-variable">encoded</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-string">"解密后的数据-&gt;"</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-operator">+</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">String</span>(<span class="cm-variable">decrypt</span>(<span class="cm-variable">key</span>, <span class="cm-variable">encoded</span>), <span class="cm-string">"utf-8"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1058px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1058px;"></div></div></div></pre><p><span>上述代码的运行结果是：</span></p><p><span>                                       </span><mark><span>加密后的数据-&gt;P湻9浪k0肟</span></mark>
<span>​                                        </span><mark><span>解密后的数据-&gt;测试数据...</span></mark></p><p><span>类似地，我们可以对class文件的字节流做同样的加密和解密操作，具体的代码放在附录。</span></p><h1 id='多线程或多并发环境的jvm'><span>多线程或多并发环境的JVM</span></h1><p><span>此类情况下，由于面临当前操作可能会被其它进程或线程修改，因此重点在于使用锁技术，以及如何维护当前的工作。</span></p><h2 id='对象创建'><span>对象创建</span></h2><p><span>根据前文的介绍，我们知道对象的创建主要的工作有：可能需要先进行类加载，再判断对象可以存放的位置，划分出指定的内存空间后，再加载自己的各种变量和方法，最后将各种引用关联起来，得到一个可以使用的对象。当然，最后需要将对象是引用与对应的对象名关联起来。</span></p><ul><li><p><span>其中，在划分内存空间的时候，如果其它线程或进程也在试图使用内存，则会导致内存分配失败。例如Eden区使用的指针碰撞技术。</span></p><ul><li><span>指针碰撞通过简单的移动便划分出新的使用内存，为保证当前的移动不被干扰，操作内部使用了CAS原语。而CAS的底层实现则是利用汇编的lock命令，锁定总线，禁止其它命令进入【这里设计者偷懒，没有针对不同CPU的特定情况优化】。</span></li></ul></li><li><p><span>对象名与实例连接：</span></p><p><span>在单例模式下，我们只需要创建一个对象并重复使用即可，但是本节的情况下，如何保证仅创建了一个对象。</span></p><p><span>大致的代码如下：</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">T</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-variable">T</span> &nbsp;<span class="cm-variable">t</span><span class="cm-operator">=</span><span class="cm-atom">null</span>;<span class="cm-comment">//准备好对象名</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//外部有大量的线程准备使用里面的对象</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">//但此时还没创建出来</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">if</span>(<span class="cm-variable">t</span><span class="cm-operator">==</span><span class="cm-atom">null</span>){<span class="cm-comment">//此时还是没有实例</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">synchronized</span> (<span class="cm-variable">T</span>.<span class="cm-keyword">class</span>){<span class="cm-comment">//锁定，并进行创建</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">if</span> (<span class="cm-variable">t</span><span class="cm-operator">==</span><span class="cm-atom">null</span>){</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">t</span><span class="cm-operator">=</span><span class="cm-keyword">new</span> <span class="cm-variable">T</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 276px;"></div><div class="CodeMirror-gutters" style="display: none; height: 276px;"></div></div></div></pre><p><span>上述流程为DCL(双重校验锁机制)，首先评估是否需要创建，避免直接进行锁竞争，获得锁之后，再次确认，避免重复创建。</span></p><ul><li><p><span>但这里存在一个问题，JVM会进行指令重排，在对象创建期间，应该是完成对象的彻底构建，才会将对象的引用交给对象名。但是指令重排，可能会提前将引用赋予对象名，导致其它线程发现已有对象并使用了不完整的实例。</span></p></li><li><p><span>为此，需要额外加上</span><code>volatile</code><span>指令，即</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> <span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-keyword">volatile</span> <span class="cm-variable">T</span> &nbsp;<span class="cm-variable">t</span><span class="cm-operator">=</span><span class="cm-atom">null</span>;</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>以禁止上述的指令重排序。</span></p><p><span>valatile功能的实现则来自内存屏障：</span></p><ul><li><span>Store：将处理器缓存的数据刷新到内存中。</span></li><li><span>Load：将内存存储的数据拷贝到处理器的缓存中。</span></li></ul><figure><table><thead><tr><th><span>屏障类型</span></th><th><span>指令示例</span></th><th><span>说明</span></th></tr></thead><tbody><tr><td><span>LoadLoad</span></td><td><span>Load1;LoadLoad;Load2</span></td><td><span>确保Load1数据的装载先于Load2及其后所有装载指令的的操作</span></td></tr><tr><td><span>StoreStore</span></td><td><span>Store1;StoreStore;Store2</span></td><td><span>确保Store1立刻刷新数据到内存(使其对其他处理器可见)的操作先于Store2及其后所有存储指令的操作</span></td></tr><tr><td><span>LoadStore</span></td><td><span>Load1;LoadStore;Store2</span></td><td><span>确保Load1的数据装载先于Store2及其后所有的存储指令刷新数据到内存的操作</span></td></tr><tr><td><span>StoreLoad</span></td><td><span>Store1;StoreLoad;Load2</span></td><td><span>确保Store1立刻刷新数据到内存的操作先于Load2及其后所有装载装载指令的操作。它会使该屏障之前的所有内存访问指令(存储指令和访问指令)完成之后,才执行该屏障之后的内存访问指令</span></td></tr></tbody></table></figure><p><span>为了实现volatile的内存语义，编译器在生成字节码时，会在指令序列中插入内存屏障来禁止特定类型的处理器重排序。在每个volatile写操作的前面插入一个StoreStore屏障，确保前面的写操作完成。在每个volatile写操作的后面插入一个StoreLoad屏障，确保自己的写操作完成。</span></p></li></ul></li><li><p><span>此外为了实现单例模式的安全性，可以使用holder模式，即插入静态内部类，以避免竞争。</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">Singleton</span> {</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 类级内部类，也就是静态的成员内部类，该内部类的实例与外部类的实例没有绑定关系</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">* 只有被调用的时候才会装载，从而实现了延迟加载，即懒汉式</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable">Singleton</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-keyword">static</span> <span class="cm-keyword">class</span> <span class="cm-def">SingletonHolder</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-comment">/**</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">* 静态初始化器，由JVM来保证线程安全</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-comment">*/</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-keyword">final</span> <span class="cm-variable">Singleton</span> <span class="cm-variable">INSTANCE</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Singleton</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span cm-text="">​</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable">Singleton</span> <span class="cm-variable">getInstance</span>() {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">SingletonHolder</span>.<span class="cm-variable">INSTANCE</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 460px;"></div><div class="CodeMirror-gutters" style="display: none; height: 460px;"></div></div></div></pre><p>&nbsp;</p></li></ul><h2 id='垃圾回收'><span>垃圾回收</span></h2><p><span>垃圾回收器在CMS之后，都开始了并发标记，即在用户线程运行期间对系统中的对象实例进行垃圾标记。这期间可能发生某些垃圾被重新引用，因此又需要进行结果修正。</span></p><p><span>而如何与用户线程共存且完成标记的任务则包含了许多思考。</span></p><ul><li><p><span>卡表：前文中就提及了卡表是维护区域之间引用关系的。但如何在对象被引用后，就将对应的卡表标记为变脏，就需要写屏障来工作。</span></p><ul><li><p><span>写屏障其实就是类似spring中的AOP编程（面向切面编程）。引用对象是切点，写屏障就是在这个切点前后增加语句执行额外的操作，以此完成卡表的标记工作。</span></p></li><li><p><span>-XX:+UseCondCardMark命令可开启有条件的写屏障，即对应的卡页已经是脏的，就不去再标记了。</span></p></li><li><p><span>伪共享，还是关于CPU缓存行的问题，如果多个卡表元素落入同一个缓存行中，不同的线程修改各自的元素，线程之间需要频繁第争夺缓存行的使用权。通过有条件的写屏障一定程度上避免了这种争夺。</span></p><ul><li><span>而类似之前一节有说过的，我们可以主动填充缓存行使其立即刷新，这里也可以人为地增加多余的成分占据一个缓存行，使得不同线程对应的卡表元素处于不同的缓存行。</span></li></ul></li></ul></li></ul><p><span>在利用卡表标记了对象之间存在引用关系之后，借助卡表就可以快速地对引用链进行遍历。但由于此时用户进程也在继续，则需要三色标记来判断对象的存活状态。</span></p><ul><li><p><span>三色标记</span></p><p><span>扫描是自上而下不断递归深入地进行。利用不同颜色标记对应的对象状况，如果是黑色，则认为上下均完成扫描，不会再从这个对象开始递归扫描。灰色代表自己被扫描，但是自己引用的对象未全部完成扫描。白色即代表那些未被扫描过的，最后指示为不可达，即被当作是垃圾对象。</span></p></li></ul><div class="md-diagram-panel md-fences-adv-panel"><svg id="mermaidChart511" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="396" style="max-width: 663.926px; height: 436px;" viewBox="0 0 663.92578125 396" class="md-require-zoom-fix"><style>#mermaidChart511{font-family:sans-serif;font-size:16px;fill:#333;}#mermaidChart511 .error-icon{fill:#552222;}#mermaidChart511 .error-text{fill:#552222;stroke:#552222;}#mermaidChart511 .edge-thickness-normal{stroke-width:2px;}#mermaidChart511 .edge-thickness-thick{stroke-width:3.5px;}#mermaidChart511 .edge-pattern-solid{stroke-dasharray:0;}#mermaidChart511 .edge-pattern-dashed{stroke-dasharray:3;}#mermaidChart511 .edge-pattern-dotted{stroke-dasharray:2;}#mermaidChart511 .marker{fill:#333333;}#mermaidChart511 .marker.cross{stroke:#333333;}#mermaidChart511 svg{font-family:sans-serif;font-size:16px;}#mermaidChart511 .label{font-family:sans-serif;color:#333;}#mermaidChart511 .label text{fill:#333;}#mermaidChart511 .node rect,#mermaidChart511 .node circle,#mermaidChart511 .node ellipse,#mermaidChart511 .node polygon,#mermaidChart511 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaidChart511 .node .label{text-align:center;}#mermaidChart511 .node.clickable{cursor:pointer;}#mermaidChart511 .arrowheadPath{fill:#333333;}#mermaidChart511 .edgePath .path{stroke:#333333;stroke-width:1.5px;}#mermaidChart511 .flowchart-link{stroke:#333333;fill:none;}#mermaidChart511 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaidChart511 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaidChart511 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaidChart511 .cluster text{fill:#333;}#mermaidChart511 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:sans-serif;font-size:12px;background:hsl(80,100%,96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaidChart511:root{--mermaid-font-family:sans-serif;}#mermaidChart511:root{--mermaid-alt-font-family:sans-serif;}#mermaidChart511 flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-id0 LE-id1" id="L-id0-id1" style="opacity: 1;"><path class="path" d="M370.6842105263158,53L327,78L327,103" marker-end="url(#arrowhead1234)" style="fill:none"></path><defs><marker id="arrowhead1234" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id1 LE-id2" id="L-id1-id2" style="opacity: 1;"><path class="path" d="M327,148L327,185.5L327,223" marker-end="url(#arrowhead1235)" style="fill:none"></path><defs><marker id="arrowhead1235" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id2 LE-duli" id="L-id2-duli" style="opacity: 1;"><path class="path" d="M261,260.67241379310343L66,305.5L66,343" marker-end="url(#arrowhead1236)" style="fill:none"></path><defs><marker id="arrowhead1236" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id2 LE-hui" id="L-id2-hui" style="opacity: 1;"><path class="path" d="M294.375,268L240,305.5L240,343" marker-end="url(#arrowhead1237)" style="fill:none"></path><defs><marker id="arrowhead1237" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id2 LE-id3" id="L-id2-id3" style="opacity: 1;"><path class="path" d="M359.625,268L414,305.5L414,343" marker-end="url(#arrowhead1238)" style="fill:none"></path><defs><marker id="arrowhead1238" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id0 LE-id4" id="L-id0-id4" style="opacity: 1;"><path class="path" d="M468,44.322785802481235L609.30859375,78L609.30859375,125.5L609.30859375,185.5L609.30859375,245.5L609.30859375,305.5L590.99072265625,343" marker-end="url(#arrowhead1239)" style="fill:none"></path><defs><marker id="arrowhead1239" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-id2 LE-id4" id="L-id2-id4" style="opacity: 1;"><path class="path" d="M393,265.3686866707171L526.30859375,305.5L559.86572265625,343" marker-end="url(#arrowhead1240)" style="fill:none;stroke-width:2px;stroke-dasharray:3;"></path><defs><marker id="arrowhead1240" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(609.30859375,185.5)" style="opacity: 1;"><g transform="translate(-46.6171875,-12.5)" class="label"><rect rx="0" ry="0" width="93.234375" height="25"></rect><foreignObject width="93.234375" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>状况1:新插入</span></div></foreignObject></g></g><g class="edgeLabel" transform="translate(526.30859375,305.5)" style="opacity: 1;"><g transform="translate(-38.6171875,-12.5)" class="label"><rect rx="0" ry="0" width="77.234375" height="25"></rect><foreignObject width="77.234375" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span>状况2:删除</span></div></foreignObject></g></g></g><g class="nodes"><g class="node default" id="flowchart-id0-1436" transform="translate(410,30.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-58" y="-22.5" width="116" height="45" class="label-container" style="fill:#000000;"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><font color="white">上下均已扫描</font></div></foreignObject></g></g></g><g class="node default" id="flowchart-id1-1437" transform="translate(327,125.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-58" y="-22.5" width="116" height="45" class="label-container" style="fill:#000000;"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><font color="white">上下均已扫描</font></div></foreignObject></g></g></g><g class="node default" id="flowchart-id2-1439" transform="translate(327,245.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-66" y="-22.5" width="132" height="45" class="label-container" style="fill:#9b9b9b;stroke:#9b9b9b;"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-56,-12.5)"><foreignObject width="112" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><font color="white">下面未完成扫描</font></div></foreignObject></g></g></g><g class="node default" id="flowchart-duli-1441" transform="translate(66,365.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-58" y="-22.5" width="116" height="45" class="label-container" style="fill:#000000;"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><font color="white">上下均已扫描</font></div></foreignObject></g></g></g><g class="node default" id="flowchart-hui-1443" transform="translate(240,365.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-66" y="-22.5" width="132" height="45" class="label-container" style="fill:#9b9b9b;stroke:#9b9b9b;"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-56,-12.5)"><foreignObject width="112" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><font color="white">下面未完成扫描</font></div></foreignObject></g></g></g><g class="node default" id="flowchart-id3-1450" transform="translate(414,365.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-58" y="-22.5" width="116" height="45" class="label-container" style="fill:#ffffff;"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">自己未被扫描</div></foreignObject></g></g></g><g class="node default" id="flowchart-id4-1452" transform="translate(580,365.5)" style="opacity: 1;"><rect rx="5" ry="5" x="-58" y="-22.5" width="116" height="45" class="label-container" style="fill:#ffffff;"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-48,-12.5)"><foreignObject width="96" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">自己未被扫描</div></foreignObject></g></g></g></g></g></g></svg></div><p><span>若同时发生了上图中的状况，最后都会导致某些存活的对象被视为垃圾。</span></p><ul><li><span>状况1：黑色对象之后突然引用了一个独立的白色对象，由于这个白色对象不被其它非黑色对象引用，导致垃圾回收器之后都不会扫描到这个对象，致使该对象被视为垃圾。</span></li><li><span>状况2：如果白色对象与所属的灰色对象直接的可达路径完全被切断，则导致之后从灰色对象向下递归扫将无法扫描到这些对象，本来这样没什么问题，但是如果这之前这些对象被黑色对象引用了，则回到了状况1的情况，同样会导致存活对象被当作垃圾。</span></li></ul><p><span>为避免对象误判为垃圾：</span></p><p><strong><span>CMS</span></strong><span>：采用增量更新</span></p><ul><li><span>即当黑色对象添加了指向白色对象的引用，则将这个新引用记录下来（相当于将黑色对象重新标记为灰色），在完成了并发标记后，将从这些黑色对象再做扫描。</span></li></ul><p><strong><span>G1</span></strong><span>：采用原始快照(STAB)</span></p><ul><li><span>相比于CMS中记录黑色对象添加的引用，这里将记录那些灰色对象删除的引用，当完成并发标记后，再对这些记录进行扫描。</span></li></ul><p><span>上述两种方式，读者会发现，都发生了一旦引用变化就会立即记录，这就是再次利用了写屏障的技术。</span></p><h1 id='其它的类加载机制'><span>其它的类加载机制</span></h1><h2 id='tomcat'><span>Tomcat</span></h2><p><span>作为一个Web应用，Tomcat需要管理多个不同的网站，即对应的不同的jar/war包，导致Tomcat内部包含了多个应用类库。常规的委派机制无法解决类与类的全限定名的冲突，故，Tomcat内部支持委派机制，但有自己的一套加载系统。</span></p><p><span>Tomcat的类加载器关系如下：【版本为Tomcat7之后】</span></p><div class="md-diagram-panel md-fences-adv-panel"><svg id="mermaidChart512" width="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="441" style="max-width: 305.914px; height: 481px;" viewBox="0 0 305.9140625 441" class="md-require-zoom-fix"><style>#mermaidChart512{font-family:sans-serif;font-size:16px;fill:#333;}#mermaidChart512 .error-icon{fill:#552222;}#mermaidChart512 .error-text{fill:#552222;stroke:#552222;}#mermaidChart512 .edge-thickness-normal{stroke-width:2px;}#mermaidChart512 .edge-thickness-thick{stroke-width:3.5px;}#mermaidChart512 .edge-pattern-solid{stroke-dasharray:0;}#mermaidChart512 .edge-pattern-dashed{stroke-dasharray:3;}#mermaidChart512 .edge-pattern-dotted{stroke-dasharray:2;}#mermaidChart512 .marker{fill:#333333;}#mermaidChart512 .marker.cross{stroke:#333333;}#mermaidChart512 svg{font-family:sans-serif;font-size:16px;}#mermaidChart512 .label{font-family:sans-serif;color:#333;}#mermaidChart512 .label text{fill:#333;}#mermaidChart512 .node rect,#mermaidChart512 .node circle,#mermaidChart512 .node ellipse,#mermaidChart512 .node polygon,#mermaidChart512 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaidChart512 .node .label{text-align:center;}#mermaidChart512 .node.clickable{cursor:pointer;}#mermaidChart512 .arrowheadPath{fill:#333333;}#mermaidChart512 .edgePath .path{stroke:#333333;stroke-width:1.5px;}#mermaidChart512 .flowchart-link{stroke:#333333;fill:none;}#mermaidChart512 .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaidChart512 .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaidChart512 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaidChart512 .cluster text{fill:#333;}#mermaidChart512 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:sans-serif;font-size:12px;background:hsl(80,100%,96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaidChart512:root{--mermaid-font-family:sans-serif;}#mermaidChart512:root{--mermaid-alt-font-family:sans-serif;}#mermaidChart512 flowchart{fill:apa;}</style><g><g class="output"><g class="clusters"></g><g class="edgePaths"><g class="edgePath LS-System LE-Bootstrap" id="L-System-Bootstrap" style="opacity: 1;"><path class="path" d="M112.5234375,103L112.5234375,78L112.5234375,53" marker-end="url(#arrowhead1264)" style="fill:none"></path><defs><marker id="arrowhead1264" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-Common LE-System" id="L-Common-System" style="opacity: 1;"><path class="path" d="M112.5234375,198L112.5234375,173L112.5234375,148" marker-end="url(#arrowhead1265)" style="fill:none"></path><defs><marker id="arrowhead1265" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-Catalina LE-Common" id="L-Catalina-Common" style="opacity: 1;"><path class="path" d="M48.7890625,293L48.7890625,268L82.33347039473685,243" marker-end="url(#arrowhead1266)" style="fill:none"></path><defs><marker id="arrowhead1266" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-Shared LE-Common" id="L-Shared-Common" style="opacity: 1;"><path class="path" d="M176.2578125,293L176.2578125,268L142.71340460526315,243" marker-end="url(#arrowhead1267)" style="fill:none"></path><defs><marker id="arrowhead1267" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-WebApp0 LE-Shared" id="L-WebApp0-Shared" style="opacity: 1;"><path class="path" d="M102.9296875,388L102.9296875,363L141.5234375,338" marker-end="url(#arrowhead1268)" style="fill:none"></path><defs><marker id="arrowhead1268" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g><g class="edgePath LS-WebApp1 LE-Shared" id="L-WebApp1-Shared" style="opacity: 1;"><path class="path" d="M249.5859375,388L249.5859375,363L210.9921875,338" marker-end="url(#arrowhead1269)" style="fill:none"></path><defs><marker id="arrowhead1269" viewBox="0 0 10 10" refX="9" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="6" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z" class="arrowheadPath" style="stroke-width: 1; stroke-dasharray: 1, 0;"></path></marker></defs></g></g><g class="edgeLabels"><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g><g class="edgeLabel" transform="" style="opacity: 1;"><g transform="translate(0,0)" class="label"><rect rx="0" ry="0" width="0" height="0"></rect><foreignObject width="0" height="0"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;"><span></span></div></foreignObject></g></g></g><g class="nodes"><g class="node default" id="flowchart-System-1469" transform="translate(112.5234375,125.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-37.5703125" y="-22.5" width="75.140625" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-27.5703125,-12.5)"><foreignObject width="55.140625" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">System</div></foreignObject></g></g></g><g class="node default" id="flowchart-Bootstrap-1470" transform="translate(112.5234375,30.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-47.4453125" y="-22.5" width="94.890625" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-37.4453125,-12.5)"><foreignObject width="74.890625" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Bootstrap</div></foreignObject></g></g></g><g class="node default" id="flowchart-Common-1471" transform="translate(112.5234375,220.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-45.4453125" y="-22.5" width="90.890625" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-35.4453125,-12.5)"><foreignObject width="70.890625" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Common</div></foreignObject></g></g></g><g class="node default" id="flowchart-Catalina-1473" transform="translate(48.7890625,315.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-40.7890625" y="-22.5" width="81.578125" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-30.7890625,-12.5)"><foreignObject width="61.578125" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Catalina</div></foreignObject></g></g></g><g class="node default" id="flowchart-Shared-1475" transform="translate(176.2578125,315.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-36.6796875" y="-22.5" width="73.359375" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-26.6796875,-12.5)"><foreignObject width="53.359375" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">Shared</div></foreignObject></g></g></g><g class="node default" id="flowchart-WebApp0-1477" transform="translate(102.9296875,410.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-48.328125" y="-22.5" width="96.65625" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-38.328125,-12.5)"><foreignObject width="76.65625" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">WebApp0</div></foreignObject></g></g></g><g class="node default" id="flowchart-WebApp1-1479" transform="translate(249.5859375,410.5)" style="opacity: 1;"><rect rx="0" ry="0" x="-48.328125" y="-22.5" width="96.65625" height="45" class="label-container"></rect><g class="label" transform="translate(0,0)"><g transform="translate(-38.328125,-12.5)"><foreignObject width="76.65625" height="25"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; white-space: nowrap;">WebApp1</div></foreignObject></g></g></g></g></g></g></svg></div><p><span>其中，WebApp0和WebApp1是随着用户自定的jar包而创建，用于加载对应目录下所有class，资源，jar文件，即负责加载指定Web的资源，且只对该Web可见。</span></p><p><span>下面是关于上图中各类加载器的解释，具体细节可查看</span><a href='[Apache Tomcat 10 (10.0.6) - Class Loader How-To](http://tomcat.apache.org/tomcat-10.0-doc/class-loader-howto.html)'><span>官方文档</span></a></p><ul><li><span>BootStrap：加载JVM提供的基本运行类，加之目录</span><code>JAVA_HOME/jre/lib/ext</code><span>下的所有jar包中的类。</span></li><li><span>System：通常从CLASSPATH环境变量的内容初始化该类加载器。但实际上是加载 Tomcat 启动脚本（$CATALINA_HOME/bin/catalina.sh |bat）指定位置的类。【所有这些类对 Tomcat 内部类和 Web 应用程序都是可见的】</span></li><li><span>Common：加载Tomcat以及应用通用类，位于CATALINA/lib目录下。是一个公用类加载器。</span></li><li><span>Catalina：用于加载Tomcat应用服务器的类加载器（路径为server.loader）。【默认路径为空，此时由Common加载应用服务器】</span></li><li><span>Shared：是Web应用的父加载器（路径为shared.loader）。【默认路径为空，此时由Common作为Web应用的父加载器】</span></li></ul><p><font color=Red><strong><span>Tomcat中类的实际加载顺序</span></strong></font><span>，需要考虑类加载器的</span><code>delegate</code><span>属性值，【默认</span><code>false</code><span>】（通过在对应的conf/Context.xml中</span><span>&lt;</span><span>Loader delegate=&quot;true&quot; /</span><span>&gt;</span><span> 进行修改。</span></p><p><span>将依此从下述位置中查找类或资源，</span></p><ul><li><p><span>false</span></p><ol start='' ><li><span>缓存</span></li><li><span>JVM的Bootstrap</span></li><li><em><span>/WEB-INF/classes</span></em><span> 目录</span></li><li><em><span>/WEB-INF/lib/</span><span>*</span><span>.jar</span></em><span> </span></li><li><span>System class loader</span></li><li><span>Common class loader</span></li></ol></li><li><p><span>true，此时将使用java默认的委派机制</span></p><ol start='' ><li><span>缓存</span></li><li><span>JVM的Bootstrap</span></li><li><span>System class loader</span></li><li><span>Common  class loader</span></li><li><em><span>/WEB-INF/classes</span></em><span> 目录</span></li><li><em><span>/WEB-INF/lib/</span><span>*</span><span>.jar</span></em></li></ol><p><span>由于这里的类初次加载时无论怎么样，都需要先经过BootstrapClassLoader（且，这里包含了也包含了扩展类），因此恶意创建的JDK基类，是无法加载的。</span></p></li></ul><h2 id='字节码生成'><span>字节码生成</span></h2><p><span>这部分就非常简单了，就是动态代理，既包含了JDK自带的Proxy类，也包含CGLib等，都属于根据已有的条件额外创建了一个class文件，也属于一种类加载机制。</span></p><h2 id='模块化'><span>模块化</span></h2><p><span>JDK9才引入了JPMS模块系统，还是静态的。而之前已经有了OSGi(Open Service Gateway Initiative)【动态模块化规范】，其中的模块一般就是已jar包的形式封装，用以实现热插拔功能。</span></p><p><span>OSGi的Bundle类加载器</span>
<span>之间只有规则，没有固定的委派关系。例如，某个Bundle声明了一个它依赖的Package，如果有其他</span>
<span>Bundle声明了发布这个Package后，那么所有对这个Package的类加载动作都会委派给发布它的Bundle类</span>
<span>加载器去完成。不涉及某个具体的Package时，各个Bundle加载器都是平级的关系，只有具体使用到某</span>
<span>个Package和Class的时候，才会根据Package导入导出定义来构造Bundle间的委派和依赖。</span>
<span>另外，一个Bundle类加载器为其他Bundle提供服务时，会根据Export-Package列表严格控制访问范</span>
<span>围。如果一个类存在于Bundle的类库中但是没有被Export，那么这个Bundle的类加载器能找到这个类，</span>
<span>但不会提供给其他Bundle使用，而且OSGi框架也不会把其他Bundle的类加载请求分配给这个Bundle来</span>
<span>处理。</span></p><h1 id='附录'><font color=Red><span>附录</span></font></h1><h2 id='class文件3des加密和解密自定义的类加载器）'><font color=red><span>class文件3DES加密和解密（自定义的类加载器）</span></font></h2><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="java" style="break-inside: unset;"><div class="CodeMirror cm-s-inner CodeMirror-wrap" lang="java"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">FilterInputStream</span>;</span></pre></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">lang</span>.<span class="cm-variable">ClassLoader</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">lang</span>.<span class="cm-variable">ClassNotFoundException</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">BufferedInputStream</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">IOException</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">BufferedOutputStream</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">java</span>.<span class="cm-variable">io</span>.<span class="cm-variable">FileOutputStream</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-keyword">public</span> <span class="cm-keyword">class</span> <span class="cm-def">MyClassLoader</span> <span class="cm-keyword">extends</span> <span class="cm-variable">ClassLoader</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">String</span> <span class="cm-variable">byteCode_Path</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">private</span> <span class="cm-variable-3">byte</span>[] <span class="cm-variable">key</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-variable">MyClassLoader</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">byteCode_Path</span>, <span class="cm-variable-3">byte</span>[] <span class="cm-variable">key</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">this</span>.<span class="cm-variable">byteCode_Path</span> <span class="cm-operator">=</span> <span class="cm-variable">byteCode_Path</span>;<span class="cm-keyword">this</span>.<span class="cm-variable">key</span> <span class="cm-operator">=</span> <span class="cm-variable">key</span>;}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-meta">@Override</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">protected</span> <span class="cm-variable">Class</span><span class="cm-operator">&lt;?&gt;</span> <span class="cm-variable">findClass</span>(<span class="cm-variable-3">String</span> <span class="cm-variable">className</span>) <span class="cm-keyword">throws</span> <span class="cm-variable">ClassNotFoundException</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span> <span class="cm-variable">value</span>[] <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">BufferedInputStream</span> <span class="cm-variable">in</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">in</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">BufferedInputStream</span>(<span class="cm-keyword">new</span> <span class="cm-variable">FileInputStream</span>(<span class="cm-variable">byteCode_Path</span> <span class="cm-operator">+</span> <span class="cm-variable">className</span> <span class="cm-operator">+</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-string">".class"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">byte</span>[<span class="cm-variable">in</span>.<span class="cm-variable">available</span>()];</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">in</span>.<span class="cm-variable">read</span>(<span class="cm-variable">value</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">IOException</span> <span class="cm-variable">e</span>) {<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();} <span class="cm-keyword">finally</span> {<span class="cm-keyword">if</span> (<span class="cm-atom">null</span> <span class="cm-operator">!=</span> <span class="cm-variable">in</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {<span class="cm-variable">in</span>.<span class="cm-variable">close</span>();} <span class="cm-keyword">catch</span> (<span class="cm-variable">IOException</span> <span class="cm-variable">e</span>) {<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();}}</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">value</span> <span class="cm-operator">=</span> <span class="cm-variable">Use3DES</span>.<span class="cm-variable">decrypt</span>(<span class="cm-variable">key</span>, <span class="cm-variable">value</span>);<span class="cm-comment">//解密,自定义的关于3DES类</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">return</span> <span class="cm-variable">defineClass</span>(<span class="cm-variable">value</span>, <span class="cm-number">0</span>, <span class="cm-variable">value</span>.<span class="cm-variable">length</span>);<span class="cm-comment">//将 byte 数组转换为一个类的 Class 对象实例 </span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp;<span class="cm-keyword">public</span> <span class="cm-keyword">static</span> <span class="cm-variable-3">void</span> <span class="cm-variable">main</span>(<span class="cm-variable-3">String</span>[] <span class="cm-variable">args</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">BufferedInputStream</span> <span class="cm-variable">in</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-keyword">try</span> {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">in</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">BufferedInputStream</span>(<span class="cm-keyword">new</span> <span class="cm-variable">FileInputStream</span>(<span class="cm-string">"class文件地址"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">src</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable-3">byte</span>[<span class="cm-variable">in</span>.<span class="cm-variable">available</span>()]; <span class="cm-variable">in</span>.<span class="cm-variable">read</span>(<span class="cm-variable">src</span>); <span class="cm-variable">in</span>.<span class="cm-variable">close</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable-3">byte</span>[] <span class="cm-variable">key</span> <span class="cm-operator">=</span> <span class="cm-string">"01234567899876543210abcd"</span>.<span class="cm-variable">getBytes</span>();<span class="cm-comment">//设置密钥</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">BufferedOutputStream</span> <span class="cm-variable">out</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">BufferedOutputStream</span>(<span class="cm-keyword">new</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">FileOutputStream</span>(<span class="cm-string">"加密后的文件地址"</span>));</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">out</span>.<span class="cm-variable">write</span>(<span class="cm-variable">Use3DES</span>.<span class="cm-variable">encrypt</span>(<span class="cm-variable">key</span>, <span class="cm-variable">src</span>));<span class="cm-comment">//解密并输出</span></span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">out</span>.<span class="cm-variable">close</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">MyClassLoader</span> <span class="cm-variable">classLoader</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">MyClassLoader</span>(<span class="cm-string">"文件上级目录"</span>,<span class="cm-variable">key</span>);</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">System</span>.<span class="cm-variable">out</span>.<span class="cm-variable">println</span>(<span class="cm-variable">classLoader</span>.<span class="cm-variable">loadClass</span>(<span class="cm-string">"对应的类名"</span>).<span class="cm-variable">getClassLoader</span>().</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="cm-variable">getClass</span>().<span class="cm-variable">getName</span>());</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  } <span class="cm-keyword">catch</span> (<span class="cm-variable">Exception</span> <span class="cm-variable">e</span>) {</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="cm-variable">e</span>.<span class="cm-variable">printStackTrace</span>();</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp; &nbsp; &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"> &nbsp;  }</span></pre><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;">}</span></pre></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 1035px;"></div><div class="CodeMirror-gutters" style="display: none; height: 1035px;"></div></div></div></pre><h2 id='调优'><span>调优</span></h2><h3 id='可视化'><span>可视化</span></h3><p><span>使用命令 </span><code>jvisualvm</code><span> ,开启jdk自带的调优工具。</span></p><blockquote><p><span>开启的页面内，将包含我们启动的所有java进程，可以在其中查看新生代和老年代以及元空间的空间使用情况。</span></p></blockquote><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p></div></div>
</body>
</html>